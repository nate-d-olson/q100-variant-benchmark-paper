# Pipeline Outputs Reference

This document provides a comprehensive catalog of all files generated by the q100-variant-benchmark pipeline. Use this guide to understand what data is available, how to load it, and when to use each output type.

## Overview

The pipeline generates outputs organized into two tiers:

- **Primary Analysis Files** (5-10 KB per file): Pre-aggregated metrics optimized for fast loading and common analyses
- **Detailed Data Files** (MB-GB per file): Full variant-level or base-level data for in-depth investigations

All files are organized by benchmark identifier using the pattern: `{bench_version}_{ref}_{var_type}`

### Benchmark Identifier Components

- `bench_version`: Benchmark version (e.g., `v5.0q`, `v4.2.1`, `v0.6`)
- `ref`: Reference genome (e.g., `GRCh38`, `GRCh37`, `CHM13v2.0`)
- `var_type`: Variant type classification
  - `smvar`: Small variants (SNPs, small indels <50bp)
  - `stvar`: Structural variants (≥50bp)

Example: `v5.0q_GRCh38_smvar` = v5.0q benchmark, GRCh38 reference, small variants

### Stratification Names

All stratification-related outputs use these consistent identifiers:

| Code | Name | Description |
|------|------|-------------|
| HP | Homopolymer | Homopolymer regions (≥7 bp) |
| MAP | Mapping Quality | Low-complexity regions with mapping issues |
| SD | Segmental Duplication | Segmental duplications |
| SD10kb | Segmental Duplication ±10kb | Flanking regions ±10kb from segmental dups |
| TR | Tandem Repeat | Tandem repeats and associated regions |
| TR10kb | Tandem Repeat ±10kb | Flanking regions ±10kb from tandem repeats |

---

## Primary Analysis Files

These files contain aggregated metrics and should be your default choice for analyses. They're fast to load and sufficient for most use cases.

### 1. Stratification Combined Metrics

**Path:** `results/var_counts/{benchmark}/stratification_combined_metrics.csv`

**Purpose:** Primary analysis file with per-stratification metrics and variant counts. Use this for all analyses comparing difficult regions, variant distributions, or benchmark characteristics.

**Size:** Small (~5-10 KB per benchmark)

**Column Schema:**

| Column | Type | Description | Range/Units |
|--------|------|-------------|-------------|
| bench_version | string | Benchmark version | e.g., "v5.0q" |
| ref | string | Reference genome | GRCh37, GRCh38, CHM13v2.0 |
| var_type | string | Variant classification | smvar or stvar |
| strat_name | string | Stratification region name | HP, MAP, SD, SD10kb, TR, TR10kb |
| strat_bp | integer | Total bases in stratification | Bases |
| intersect_bp | integer | Bases overlapping with benchmark | Bases |
| pct_of_strat | decimal | Percentage of stratification in benchmark | 0-100% |
| pct_of_bench | decimal | Percentage of benchmark in stratification | 0-100% |
| total_variants | integer | Total variant count in overlap | Count |
| snp_count | integer | SNP count | Count |
| indel_count | integer | INDEL count | Count |
| del_count | integer | Deletion count (structural variants) | Count |
| ins_count | integer | Insertion count (structural variants) | Count |
| complex_count | integer | Complex variant count | Count |
| other_count | integer | Other/unclassified variant count | Count |
| variant_density_per_mb | decimal | Variants per megabase | variants/Mb |

**Example Data:**
```
strat_name,strat_bp,intersect_bp,pct_of_strat,pct_of_bench,total_variants,snp_count,indel_count,del_count,ins_count,complex_count,other_count,variant_density_per_mb
HP,83977437,80057238,95.331843,2.922429,745376,180354,554178,0,0,0,10844,9310.54
MAP,248876839,113370415,45.552819,4.138501,851471,724227,86411,0,0,0,40833,7510.52
SD,166860344,81066975,48.583728,2.959288,505283,405788,73868,0,0,0,25627,6232.91
```

**Usage Notes:**
- Recommended file for most analyses
- One row per stratification per benchmark
- Ideal for creating comparison plots and summary tables
- Use `load_stratification_metrics()` function to load

**Example Usage:**
```r
source("R/data_loading.R")

# Load all metrics
metrics <- load_stratification_metrics()

# Load specific benchmark
metrics_v5 <- load_stratification_metrics(
  benchmark_filter = c("v5.0q_GRCh38_smvar", "v5.0q_GRCh37_stvar")
)

# Summarize variant density by benchmark
metrics %>%
  group_by(bench_version, ref) %>%
  summarise(
    mean_density = mean(variant_density_per_mb),
    total_variants = sum(total_variants)
  )
```

---

### 2. Exclusions Intersection Table

**Path:** `results/exclusions/{benchmark}/exclusions_intersection_table.csv`

**Availability:** v5.0q benchmarks only (v4.2.1 and earlier use different exclusion definitions)

**Purpose:** Quantifies how much each exclusion category overlaps with benchmark regions. Use this to understand what was excluded and why.

**Size:** Small (~1-2 KB per benchmark)

**Column Schema:**

| Column | Type | Description |
|--------|------|-------------|
| bench_version | string | Benchmark version |
| ref | string | Reference genome |
| var_type | string | Variant type classification |
| exclusions | string | Exclusion category name |
| exclusion_bp | integer | Total bases in exclusion region (bases) |
| intersect_bp | integer | Bases overlapping with benchmark (bases) |
| pct_of_exclusion | decimal | % of exclusion overlapping benchmark (0-100) |
| pct_of_dip | decimal | % of diploid genome represented (0-100) |

**Exclusion Categories:**
- `consecutive-svs`: Regions with multiple consecutive structural variants
- `flanks`: Flanking regions around large features
- `satellites`: Satellite DNA regions
- `segdups`: Segmental duplications >90% identity
- `LCR-unique`: Low-complexity repetitive regions
- `tandem-repeats`: Annotated tandem repeats

**Example Data:**
```
exclusions,exclusion_bp,intersect_bp,pct_of_exclusion,pct_of_dip
segdups,47895628,23405873,48.843702,0.853401
tandem-repeats,34562984,12843567,37.176483,0.468192
```

**Usage Notes:**
- Only available for v5.0q benchmarks
- Shows which exclusions most impact benchmark completeness
- `pct_of_exclusion` indicates how stringent each filter was
- Use `load_exclusion_metrics()` to load

**Example Usage:**
```r
exclusions <- load_exclusion_metrics()

# Find most impactful exclusions
exclusions %>%
  arrange(desc(intersect_bp)) %>%
  mutate(impact = intersect_bp / exclusion_bp) %>%
  select(exclusions, intersect_bp, impact)
```

---

### 3. Reference Genome Sizes

**Path:** `results/ref_genome_sizes/{ref}_size.tsv`

**Purpose:** Reference genome sizes and N-content. Use for normalizing metrics, calculating percentages, and verifying data completeness.

**Size:** Small (~1 KB per reference)

**Column Schema:**

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| ref | string | Reference genome name | GRCh38 |
| chrom | string | Chromosome name (with "chr" prefix) | chr1 |
| length | integer | Total chromosome length (bp) | 248956422 |
| ns | integer | Number of N bases | 10000 |
| asm_bp | integer | Assembled bases (length - ns) | 248946422 |

**Notes on Calculation:**
- `asm_bp` = `length` - `ns` (true assembled sequence)
- Use `asm_bp` for percentage calculations involving the complete genome
- `ns` indicates unmapped or low-confidence regions in reference

**Example Data:**
```
ref,chrom,length,ns,asm_bp
GRCh38,chr1,248956422,10000,248946422
GRCh38,chr2,242193529,8500,242185029
GRCh38,chr3,198295559,5200,198290359
```

**Genome-wide Statistics:**

| Reference | Total Length | Total N | Total Assembled | Notes |
|-----------|--------------|---------|-----------------|-------|
| GRCh37 | 3.1 Gb | ~150 Mb | ~2.95 Gb | hg19 assembly |
| GRCh38 | 3.2 Gb | ~175 Mb | ~3.02 Gb | GRCh38/hg38 assembly |
| CHM13v2.0 | 3.05 Gb | ~90 Mb | ~2.96 Gb | Complete genome reference |

**Usage Notes:**
- Chromosomes have "chr" prefix (chr1, chr2, ..., chrX, chrY, chrM)
- Use for normalizing metrics to genome scale
- Essential for calculating benchmark completeness percentages
- Use `load_reference_sizes()` to load

**Example Usage:**
```r
ref_sizes <- load_reference_sizes()

# Calculate total assembled bases per reference
ref_sizes %>%
  group_by(ref) %>%
  summarise(
    total_bp = sum(length),
    total_n = sum(ns),
    total_asm_bp = sum(asm_bp),
    pct_assembled = 100 * sum(asm_bp) / sum(length)
  )

# Normalize benchmark coverage to genome size
metrics <- load_stratification_metrics()
ref_sizes_df <- load_reference_sizes()

genome_totals <- ref_sizes_df %>%
  group_by(ref) %>%
  summarise(total_asm_bp = sum(asm_bp))

metrics %>%
  left_join(genome_totals) %>%
  mutate(
    pct_of_genome = 100 * pct_of_bench / 100 * total_asm_bp
  )
```

---

## Detailed Data Files

These files contain variant-level or base-level data. Load them only when you need detail beyond aggregated metrics.

### 4. Full Variant Table

**Path:** `results/variant_tables/{benchmark}/variants.tsv`

**Availability:** All benchmarks

**Purpose:** Complete variant-level data for in-depth analysis. Use only when you need variant-by-variant information (e.g., analyzing specific variant characteristics, filtering by properties beyond what's in aggregated metrics).

**Size:** Large (~500 MB - 2 GB per benchmark)

**⚠️ Performance Warning:** Loading full variant tables is slow (several minutes) and memory-intensive. Consider using `load_stratification_metrics()` for summary statistics instead.

**Column Schema:**

| Column | Type | Description |
|--------|------|-------------|
| chrom | string | Chromosome (e.g., "chr1") |
| pos | integer | Start position (1-based) |
| end | integer | End position (inclusive) |
| ref | string | Reference allele |
| alt | string | Alternate allele |
| gt | string | Genotype (typically "." for benchmark) |
| vkx | string | Variant class |
| var_type | string | Variant type (SNP, INDEL, DEL, INS, COMPLEX, OTHER) |
| len_ref | integer | Reference allele length |
| len_alt | integer | Alternate allele length |
| var_size | integer | Size of variant (len_alt - len_ref) |
| region_ids | string | Region classification codes |
| (additional fields) | varies | Source-specific annotations |

**Data Quality Notes:**
- Only includes variants within benchmark regions (region_ids starts with "BMKREGIONS")
- Small variants: exclude variants <50bp
- Structural variants: include only variants ≥50bp
- Variants may overlap with difficult regions (see `region_ids`)

**Usage Notes:**
- SLOW to load - cache the loaded data if you'll use it multiple times
- Consider filtering before loading: by chromosome, variant type, or position range
- The variant table is generated by merging multiple source files
- Default: load with filters to reduce memory usage

**Example Usage:**
```r
source("R/data_loading.R")

# Load with filters to reduce memory usage
variants <- load_variant_table(
  "v5.0q_GRCh38_smvar",
  filters = list(
    chromosomes = c("chr1", "chr2"),  # Limit to ~8% of data
    variant_types = c("SNP"),
    in_benchmark_only = TRUE
  )
)

# Analyze variant characteristics
variants %>%
  group_by(var_type) %>%
  summarise(
    count = n(),
    mean_size = mean(var_size),
    max_size = max(var_size)
  )

# Find variants at specific positions
interesting_vars <- variants %>%
  filter(chrom == "chr1", pos > 1000000, pos < 2000000)
```

---

### 5. Difficult Region Coverage

**Path:** `results/diff_region_coverage/{benchmark}/{strat}_cov.bed`

**Purpose:** Base-level coverage information from bedtools coverage. Use this to understand how much of each stratification region overlaps with benchmarks at base-level granularity.

**Size:** Large (~100 MB - 1 GB per benchmark)

**File Format:** Standard BED format (tab-delimited) with bedtools coverage columns

**Column Schema:**

| Column | Type | Description |
|--------|------|-------------|
| strat_name | string | Stratification region name (extracted from filename) |
| chrom | string | Chromosome |
| start | integer | Start position (0-based, BED format) |
| end | integer | End position (exclusive) |
| n_overlap | integer | Number of overlapping intervals from bedtools |
| bases_cov | integer | Bases covered (from bedtools) |
| ivl_len | integer | Total interval length (end - start) |
| frac_cov | decimal | Fraction covered (bases_cov / ivl_len) |

**Example Data:**
```
strat_name  chrom  start     end       n_overlap  bases_cov  ivl_len  frac_cov
HP          chr1   10000     10500     1          500        500      1.0
HP          chr1   20000     20200     0          0          200      0.0
HP          chr1   25000     25500     2          450        500      0.9
```

**Understanding the Columns:**
- `n_overlap`: How many benchmark regions overlap this stratification interval
  - 0 = not covered by any benchmark
  - 1+ = covered by one or more benchmark regions
- `frac_cov`: Useful for identifying partially covered regions
  - 0.0 = completely uncovered
  - 1.0 = completely covered
  - 0.0-1.0 = partially covered (edge cases)

**Usage Notes:**
- One file per stratification per benchmark (6 strat × 8 benchmarks = 48 files)
- Files are generated from `bedtools coverage -a stratification.bed -b benchmark.bed`
- Start positions are 0-based (BED format); add 1 for 1-based coordinates if needed
- Use `load_diff_coverage()` to load and parse

**Example Usage:**
```r
source("R/data_loading.R")

# Load coverage for all stratifications
coverage <- load_diff_coverage("v5.0q_GRCh38_smvar")

# Load only specific stratifications
hp_tr_coverage <- load_diff_coverage(
  "v5.0q_GRCh38_smvar",
  strat_filter = c("HP", "TR")
)

# Find uncovered regions in HP stratification
uncovered <- coverage %>%
  filter(strat_name == "HP", frac_cov == 0.0) %>%
  arrange(chrom, start)

# Calculate coverage statistics by stratification
coverage %>%
  group_by(strat_name) %>%
  summarise(
    total_intervals = n(),
    fully_covered = sum(frac_cov == 1.0),
    partially_covered = sum(frac_cov > 0.0 & frac_cov < 1.0),
    uncovered = sum(frac_cov == 0.0),
    mean_frac_covered = mean(frac_cov)
  )
```

---

## Output Directory Structure

```
results/
├── var_counts/
│   ├── v5.0q_GRCh38_smvar/
│   │   ├── stratification_combined_metrics.csv    ✓ Primary (load first)
│   │   ├── stratification_summary.csv             (intermediate)
│   │   └── variants_by_stratification.csv         (intermediate)
│   ├── v5.0q_GRCh38_stvar/
│   ├── v5.0q_GRCh37_smvar/
│   ├── v5.0q_GRCh37_stvar/
│   ├── v5.0q_CHM13v2.0_smvar/
│   ├── v5.0q_CHM13v2.0_stvar/
│   ├── v4.2.1_GRCh38_smvar/
│   ├── v0.6_GRCh37_stvar/
│   └── [other benchmarks]
│
├── exclusions/
│   ├── v5.0q_GRCh38_smvar/
│   │   └── exclusions_intersection_table.csv      ✓ Primary (v5.0q only)
│   ├── v5.0q_GRCh38_stvar/
│   └── [other v5.0q benchmarks]
│
├── variant_tables/
│   ├── v5.0q_GRCh38_smvar/
│   │   └── variants.tsv                           ⚠️ Large (~1 GB)
│   ├── v5.0q_GRCh38_stvar/
│   └── [other benchmarks]
│
├── diff_region_coverage/
│   ├── v5.0q_GRCh38_smvar/
│   │   ├── HP_cov.bed                            ⚠️ Large files
│   │   ├── MAP_cov.bed
│   │   ├── SD_cov.bed
│   │   ├── SD10kb_cov.bed
│   │   ├── TR_cov.bed
│   │   └── TR10kb_cov.bed
│   └── [other benchmarks]
│
└── ref_genome_sizes/
    ├── GRCh37_size.tsv                           ✓ Small
    ├── GRCh38_size.tsv
    └── CHM13v2.0_size.tsv
```

Legend:
- ✓ = Recommended for most analyses (small, fast)
- ⚠️ = Use carefully (large files, slow loading)
- (intermediate) = Generated during pipeline, not typically needed for analysis

---

## Recommended Analysis Workflow

### For Summary Analyses (Most Common)

```r
source("R/data_loading.R")

# 1. Load primary metrics
metrics <- load_stratification_metrics()
ref_sizes <- load_reference_sizes()

# 2. Combine with genome sizes for normalization
genome_totals <- ref_sizes %>%
  group_by(ref) %>%
  summarise(total_asm_bp = sum(asm_bp))

metrics_normalized <- metrics %>%
  left_join(genome_totals) %>%
  mutate(benchmark_coverage_pct = 100 * pct_of_bench)

# 3. Create visualizations
metrics_normalized %>%
  ggplot(aes(x = strat_name, y = variant_density_per_mb, fill = var_type)) +
  geom_col(position = "dodge") +
  facet_wrap(~ref) +
  theme_minimal()
```

### For Variant-Level Investigations

```r
source("R/data_loading.R")

# 1. Start with metrics to understand distribution
metrics <- load_stratification_metrics()
filter(metrics, var_type == "smvar", ref == "GRCh38")

# 2. If you need details, load variant table with filters
variants <- load_variant_table(
  "v5.0q_GRCh38_smvar",
  filters = list(
    chromosomes = c("chr1"),  # Limit scope
    variant_types = c("SNP", "INDEL")
  )
)

# 3. Analyze filtered variants
variants %>%
  group_by(var_type) %>%
  summarise(
    n = n(),
    mean_size = mean(var_size),
    sd_size = sd(var_size)
  )
```

### For Coverage-Level Analysis

```r
source("R/data_loading.R")

# Load coverage data
coverage <- load_diff_coverage(
  "v5.0q_GRCh38_smvar",
  strat_filter = c("HP", "TR")
)

# Analyze coverage patterns
coverage %>%
  group_by(strat_name, chrom) %>%
  summarise(
    pct_covered = 100 * sum(bases_cov) / sum(ivl_len),
    n_regions = n(),
    mean_region_size = mean(ivl_len)
  )
```

---

## Loading Functions Summary

All output files can be loaded using functions in `R/data_loading.R`:

| Function | Purpose | Returns | Notes |
|----------|---------|---------|-------|
| `load_stratification_metrics()` | Load primary analysis metrics | Tibble | 48+ rows (6 strats × benchmarks) |
| `load_exclusion_metrics()` | Load exclusion overlaps | Tibble | v5.0q only, warns if empty |
| `load_reference_sizes()` | Load reference genomes | Tibble | 88-94 rows (24-31 chroms × refs) |
| `load_variant_table()` | Load full variant data | Tibble | Millions of rows, SLOW |
| `load_diff_coverage()` | Load base-level coverage | Tibble | Millions of rows |

All functions handle:
- Automatic file discovery in standard directory structure
- Metadata parsing from benchmark IDs
- Column type validation
- Optional filtering
- Informative error messages

---

## File Size Reference

| Output Type | Benchmark Count | Total Size |
|-------------|-----------------|-----------|
| Stratification metrics | 8 | ~80 KB |
| Exclusion tables | 4 (v5.0q only) | ~8 KB |
| Reference sizes | 3 | ~6 KB |
| Variant tables | 8 | ~4-6 GB |
| Coverage files | 8 × 6 = 48 | ~4-8 GB |
| **Total** | - | **~8-14 GB** |

*Sizes are approximate and may vary depending on reference genome and variant density*

---

## Troubleshooting

### "No stratification_combined_metrics.csv files found"
- Check that `results/var_counts/` directory exists
- Verify pipeline completed successfully
- Run `find results/ -name "*stratification_combined_metrics*"`

### Slow loading of variant tables
- Expected - these files are ~1 GB each
- Use filters to reduce memory: `load_variant_table(..., filters = list(chromosomes = c("chr1")))`
- Consider using `load_stratification_metrics()` instead for summary statistics

### Missing exclusion files
- Exclusion data only available for v5.0q benchmarks
- Earlier benchmarks use different exclusion definitions
- Check benchmark version with: `load_stratification_metrics() %>% distinct(bench_version)`

### Chromosome name mismatches
- Reference sizes always have "chr" prefix (chr1, chr2, ...)
- Variant tables may or may not have prefix depending on source
- Use `stringr::str_detect(chrom, "^chr")` to standardize

---

## Related Documentation

- **[Data Dictionary](data-dictionary.md)** - Detailed definitions of metrics and stratifications
- **[Output Relationships Diagram](diagrams/output-relationships.mmd)** - Visual guide to file dependencies
- **[Architecture Overview](architecture.md)** - How outputs are generated in the pipeline
- **[R Data Loading Functions](../R/data_loading.R)** - Function documentation and examples
