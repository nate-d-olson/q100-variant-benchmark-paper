---
title: "GIAB v5q HG002 Variant Benchmark Set Analysis"
author: "Genome in a Bottle Consortium"
date: today
format:
  html:
    toc: true
    number-sections: true
  gfm:
    toc: true
    number-sections: true
bibliography: manuscript/references.bib
---

# TODO
- simplify pipeline by renaming downloads
- drop reference processing step
- improve results and output paths
- cleanup var_table rules code, drop unnecessary scripts functions
- adding ref, bench version, and var_type to config to simplify

# Overview

This repository contains the analysis pipeline and manuscript for the **GIAB v5q HG002 Variant Benchmark Set**. The benchmark set provides high-confidence variant calls for HG002 (NA24385) using the T2T HG002 Q100 diploid assembly, with coordinates available for GRCh37, GRCh38, and CHM13v2.0 (T2T) reference genomes.

## Pipeline Purpose

The Snakemake pipeline processes benchmark set files to:

1. **Download and validate** benchmark VCF/BED files and reference genomes
2. **Annotate variants** with genomic stratification contexts using bcftools
3. **Generate variant tables** with comprehensive per-variant annotations (type, size, genomic context)
4. **Calculate overlap** with stratification regions (tandem repeats, homopolymers, segmental duplications, low mappability)
5. **Generate stratification overlap tables** showing percent coverage of difficult regions by benchmark regions (for cumulative distribution plots and inclusion analysis)
6. **Generate exclusion metrics** showing regions excluded from the benchmark and their impact
7. **Compare with historical benchmarks** (v4.2.1, CMRG, v0.6 SV, TR benchmarks)

## Key Outputs

- Annotated VCFs with stratification and region annotations (`results/annotated_vcfs/`)
- Comprehensive variant tables with per-variant annotations (`results/var_tables/`)
- Stratification overlap tables showing percent coverage of difficult regions (`results/stratification_overlap/`)
- Exclusion intersection tables (`results/exclusions/`)

# Getting Started

## Prerequisites

- [Mamba](https://mamba.readthedocs.io/) or [Conda](https://docs.conda.io/)
- [Snakemake](https://snakemake.readthedocs.io/) >= 8.0
- [snakefmt](https://github.com/snakemake/snakefmt) (for development)

## Installation

```bash
# Clone the repository
git clone https://github.com/nate-d-olson/q100-variant-benchmark-paper.git
cd q100-variant-benchmark-paper

# Create and activate the environment
mamba env create -f environment.yaml
mamba activate q100-smk
```

## Running the Pipeline

```bash
# Dry-run to validate workflow
snakemake -n --quiet

# Run pipeline locally with conda environments
snakemake --cores 4 --sdm conda

# Run using the Makefile shortcuts
make dry-run   # Validate workflow
make lint      # Check best practices
make test      # Run all validation tests
make run       # Execute the pipeline
```

# Repository Structure

```
project-root/
├── workflow/                # Snakemake pipeline
│   ├── Snakefile           # Main workflow entry point
│   ├── rules/              # Rule definitions
│   │   ├── common.smk      # Helper functions
│   │   ├── downloads.smk   # Download rules
│   │   ├── var_tables.smk  # Variant annotation and table generation
│   │   ├── vcf_processing.smk  # VCF analysis rules
│   │   └── exclusions.smk  # Exclusion analysis rules
│   ├── envs/               # Conda environment definitions
│   │   ├── bcftools.yaml
│   │   ├── bedtools.yaml
│   │   ├── samtools.yaml
│   │   └── truvari.yaml
│   └── scripts/            # Custom Python/R scripts
├── config/
│   └── config.yaml         # Pipeline configuration
├── manuscript/             # Quarto manuscript files
│   ├── introduction.qmd
│   ├── methods.qmd
│   ├── results.qmd
│   ├── discussion.qmd
│   └── references.bib
├── analysis/               # Supplementary analysis notebooks
├── data/                   # Input data files (local)
├── resources/              # Downloaded resources
├── results/                # Pipeline outputs
├── environment.yaml        # Mamba environment spec
├── Makefile               # Development shortcuts
└── _quarto.yml            # Quarto project config
```

# Benchmark Sets Analyzed

| Benchmark | Reference | Variant Type | Description |
|-----------|-----------|--------------|-------------|
| v5q_chm13_smvar | CHM13v2.0 | Small variants | T2T Q100 benchmark (SNPs + indels <50bp) |
| v5q_chm13_stvar | CHM13v2.0 | Structural variants | T2T Q100 benchmark (SVs ≥50bp) |
| v5q_grch38_smvar | GRCh38 | Small variants | T2T Q100 liftover |
| v5q_grch38_stvar | GRCh38 | Structural variants | T2T Q100 liftover |
| v5q_grch37_smvar | GRCh37 | Small variants | T2T Q100 liftover |
| v5q_grch37_stvar | GRCh37 | Structural variants | T2T Q100 liftover |
| v421_grch38_smvar | GRCh38 | Small variants | Historical GIAB v4.2.1 |
| cmrg_grch38_smvar | GRCh38 | Small variants | CMRG difficult regions |
| cmrg_grch38_stvar | GRCh38 | Structural variants | CMRG difficult regions |
| v06_grch37_stvar | GRCh37 | Structural variants | Historical SV v0.6 |
| tr_grch38_trvar | GRCh38 | Tandem repeats | TR benchmark v1.0 |

# Genomic Stratification Contexts

The pipeline analyzes benchmark overlap with GIAB v3.6 stratification regions:

| Context | Description |
|---------|-------------|
| TR | All tandem repeats |
| TR10kb | Tandem repeats ≥101bp with 5bp slop |
| HP | Homopolymers ≥7bp (perfect) or ≥11bp (imperfect) |
| SD | All segmental duplications |
| SD10kb | Segmental duplications >10kb |
| MAP | Low mappability regions |

## Stratification Overlap Analysis

The pipeline generates stratification overlap tables showing how much of each difficult genomic region is covered by the benchmark regions. This analysis enables:

1. **Inclusion Assessment**: Quantify what percentage of difficult contexts are included in the benchmark
2. **Interval-Level Coverage**: Per-interval overlap percentages for detailed analysis
3. **Cumulative Distribution Plots**: Visualize the distribution of coverage across all intervals
4. **Benchmark Comparison**: Compare inclusion of difficult regions across benchmark versions

### Output Format

The stratification overlap tables (`results/stratification_overlap/{benchmark}/overlap_table.tsv`) contain:

| Column | Description |
|--------|-------------|
| `stratification` | Name of the stratification (TR, HP, SD, MAP, etc.) |
| `chrom` | Chromosome |
| `start` | Interval start position |
| `end` | Interval end position |
| `length` | Length of the interval (bp) |
| `overlap_bp` | Bases overlapping with benchmark regions (bp) |
| `percent_overlap` | Percentage of interval covered by benchmark (0-100) |

### Example Analysis in R

```r
# Load the overlap table
library(tidyverse)

overlap_data <- read_tsv("results/stratification_overlap/v5q_chm13_smvar/overlap_table.tsv")

# Cumulative distribution plot
overlap_data %>%
  ggplot(aes(x = percent_overlap, color = stratification)) +
  stat_ecdf() +
  labs(
    title = "Cumulative Distribution of Stratification Coverage",
    x = "Percent of Interval Covered by Benchmark (%)",
    y = "Cumulative Proportion of Intervals"
  )

# Summary statistics by stratification
overlap_data %>%
  group_by(stratification) %>%
  summarize(
    mean_coverage = mean(percent_overlap),
    median_coverage = median(percent_overlap),
    fully_covered = sum(percent_overlap == 100) / n() * 100
  )
```

# Development

## Code Quality

```bash
# Run linting and format checks
make test

# Format Snakemake files
make format
```

## Commit Conventions

This project uses [Conventional Commits](https://www.conventionalcommits.org/):

- `feat:` - New feature or analysis
- `fix:` - Bug fix
- `docs:` - Documentation updates
- `chore:` - Maintenance (dependencies, configs)
- `refactor:` - Code restructuring

# Citation

If you use this benchmark set, please cite:

> [Citation to be added upon publication]

# License

This project is licensed under CC0 1.0 Universal - see the LICENSE file for details.

# Acknowledgments

This work was supported by the Genome in a Bottle Consortium at NIST.