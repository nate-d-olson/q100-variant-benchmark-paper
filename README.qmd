---
title: "GIAB v5q HG002 Variant Benchmark Set Analysis"
author: "Genome in a Bottle Consortium"
date: today
format:
  html:
    toc: true
    number-sections: true
  gfm:
    toc: true
    number-sections: true
bibliography: manuscript/references.bib
---

# Overview

This repository contains the analysis pipeline and manuscript for the **GIAB v5q HG002 Variant Benchmark Set**. The benchmark set provides high-confidence variant calls for HG002 (NA24385) using the T2T HG002 Q100 diploid assembly, with coordinates available for GRCh37, GRCh38, and CHM13v2.0 (T2T) reference genomes.

## Pipeline Purpose

The Snakemake pipeline processes benchmark set files to:

1. **Download and validate** benchmark VCF/BED files and reference genomes
2. **Annotate variants** with genomic stratification contexts using bcftools
3. **Generate variant tables** with comprehensive per-variant annotations (type, size, genomic context)
4. **Calculate overlap** with stratification regions (tandem repeats, homopolymers, segmental duplications, low mappability)
5. **Generate exclusion metrics** showing regions excluded from the benchmark and their impact
6. **Compare with historical benchmarks** (v4.2.1, v0.6 SV)

## Key Outputs

- Annotated VCFs with stratification and region annotations (`results/annotate_vcf_regions/`)
- Comprehensive variant tables with per-variant annotations (`results/variant_tables/`)
- Exclusion intersection tables (`results/exclusions/`)

# Getting Started

## Prerequisites

- [Mamba](https://mamba.readthedocs.io/) or [Conda](https://docs.conda.io/)
- [Snakemake](https://snakemake.readthedocs.io/) >= 8.0
- [snakefmt](https://github.com/snakemake/snakefmt) (for development)

## Installation

```bash
# Clone the repository
git clone https://github.com/nate-d-olson/q100-variant-benchmark-paper.git
cd q100-variant-benchmark-paper

# Create and activate the environment
mamba env create -f environment.yaml
mamba activate q100-smk
```

## Running the Pipeline

```bash
# Dry-run to validate workflow
snakemake -n --quiet

# Run pipeline locally with conda environments
snakemake --cores 4 --sdm conda

# Run using the Makefile shortcuts
make dry-run   # Validate workflow
make lint      # Check best practices
make test      # Run all validation tests
make run       # Execute the pipeline
```

# Repository Structure

```
project-root/
├── workflow/                # Snakemake pipeline
│   ├── Snakefile           # Main workflow entry point
│   ├── rules/              # Rule definitions
│   │   ├── common.smk      # Helper functions
│   │   ├── downloads.smk   # Download rules
│   │   ├── var_tables.smk  # Variant annotation and table generation
│   │   ├── vcf_processing.smk  # VCF analysis rules
│   │   └── exclusions.smk  # Exclusion analysis rules
│   ├── envs/               # Conda environment definitions
│   │   ├── bcftools.yaml
│   │   ├── bedtools.yaml
│   │   ├── downloads.yaml
│   │   ├── python.yaml
│   │   ├── rtg-tools.yaml
│   │   ├── samtools.yaml
│   │   └── truvari.yaml
│   └── scripts/            # Custom Python scripts
│       ├── combine_beds_with_id.py
│       ├── count_variants_by_type.py
│       ├── expand_annotations.py
│       ├── extract_info_fields.py
│       └── generate_header_lines.py
├── config/
│   └── config.yaml         # Pipeline configuration
├── manuscript/             # Quarto manuscript files
│   ├── introduction.qmd
│   ├── methods.qmd
│   ├── results.qmd
│   ├── discussion.qmd
│   └── references.bib
├── analysis/               # Supplementary analysis notebooks
├── data/                   # Input data files (local)
├── resources/              # Downloaded resources
├── results/                # Pipeline outputs
├── environment.yaml        # Mamba environment spec
├── Makefile               # Development shortcuts
└── _quarto.yml            # Quarto project config
```

# Benchmark Sets Analyzed

| Benchmark | Reference | Variant Type | Description |
|-----------|-----------|--------------|-------------|
| v5q_chm13_smvar | CHM13v2.0 | Small variants | T2T Q100 benchmark (SNPs + indels <50bp) |
| v5q_chm13_stvar | CHM13v2.0 | Structural variants | T2T Q100 benchmark (SVs ≥50bp) |
| v5q_grch38_smvar | GRCh38 | Small variants | T2T Q100 liftover |
| v5q_grch38_stvar | GRCh38 | Structural variants | T2T Q100 liftover |
| v5q_grch37_smvar | GRCh37 | Small variants | T2T Q100 liftover |
| v5q_grch37_stvar | GRCh37 | Structural variants | T2T Q100 liftover |
| v421_grch38_smvar | GRCh38 | Small variants | Historical GIAB v4.2.1 |
| v06_grch37_stvar | GRCh37 | Structural variants | Historical SV v0.6 |

# Genomic Stratification Contexts

The pipeline analyzes benchmark overlap with GIAB v3.6 stratification regions:

| Context | Description |
|---------|-------------|
| TR | All tandem repeats |
| TR10kb | Tandem repeats ≥10001bp with 5bp slop |
| HP | Homopolymers ≥7bp (perfect) or ≥11bp (imperfect) |
| SD | All segmental duplications |
| SD10kb | Segmental duplications >10kb |
| MAP | Low mappability regions |

# Pipeline Improvements (2026-01)

Recent enhancements have significantly improved pipeline reliability, maintainability, and usability. See [`IMPROVEMENT_SUGGESTIONS.md`](IMPROVEMENT_SUGGESTIONS.md) and [`IMPLEMENTATION_SUMMARY.md`](IMPLEMENTATION_SUMMARY.md) for complete details.

## New Features

### Structured Logging & Error Handling
- Professional logging with consistent format: `[TIMESTAMP] [LEVEL] [MODULE] Message`
- Context-rich error messages with file paths, line numbers, and actionable suggestions
- Custom exception classes for different failure modes (ValidationError, DataFormatError, ProcessingError)

### Data Validation Layer
- Automated VCF/BED/TSV format validation before processing
- Early detection of corrupted files and format violations
- Detailed validation reports in `results/validation/`

### Comprehensive Documentation
- **[Architecture Documentation](docs/architecture.md)** - System design with visual diagrams
- **[API Reference](docs/api-reference.md)** - Complete documentation of 15+ helper functions
- **[Troubleshooting Guide](docs/troubleshooting.md)** - Solutions for common issues

### Unit Testing Framework
- 35+ tests with 80%+ code coverage for core modules
- Pytest infrastructure with fixtures and coverage reporting
- See [`tests/README.md`](tests/README.md) for usage

## Testing

```bash
# Install test dependencies
pip install -e ".[dev]"

# Run all tests with coverage
pytest

# Generate HTML coverage report
pytest --cov-report=html
```

# Development

## Code Quality

```bash
# Run linting and format checks
make test

# Format Snakemake files
make format
```

## Commit Conventions

This project uses [Conventional Commits](https://www.conventionalcommits.org/):

- `feat:` - New feature or analysis
- `fix:` - Bug fix
- `docs:` - Documentation updates
- `chore:` - Maintenance (dependencies, configs)
- `refactor:` - Code restructuring

# Citation

If you use this benchmark set, please cite:

> [Citation to be added upon publication]

# License

This project is licensed under CC0 1.0 Universal - see the LICENSE file for details.

# Acknowledgments

This work was supported by the Genome in a Bottle Consortium at NIST.