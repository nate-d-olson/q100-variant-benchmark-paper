---
title: "Benchmark Set Coverage and Variants Counts for Difficult Regions"
date: '`r Sys.Date()`'
author: "ND Olson"
format:
  html:
    theme: flatly
    page-layout: full
    toc: true
    self-contained: true
  docx: default
editor: source
code-fold: true
execute:
  warning: false
---


```{r}
library(tidyverse)
library(here)
library(patchwork)

# Load shared data loading functions
source(here("R/data_loading.R"))
```

## Data Loading

```{r}
# Load base-level coverage for difficult regions using standardized loading function
benchmarks <- c(
  "v5.0q_GRCh38_smvar",
  "v5.0q_GRCh37_stvar",
  "v4.2.1_GRCh38_smvar",
  "v0.6_GRCh37_stvar"
) %>%
  set_names()

diff_cov_df <- benchmarks %>%
  map_dfr(
    ~ load_diff_coverage(.x),
    .id = "benchmark"
  ) %>%
  # Standardize column names for compatibility with existing analysis code
  rename(
    CHROM = chrom,
    START = start,
    END = end,
    num_overlap = n_overlap,
    bases_covered = bases_cov,
    interval_bp = ivl_len
  ) %>%
  # Create bench_context column for grouping (benchmark/genomic context)
  mutate(
    bench_context = glue::glue("{benchmark}/{context_name}")
  ) %>%
  select(-benchmark)
```

```{r}
#| echo: false
glimpse(diff_cov_df)
```

```{r}
# Aggregate coverage metrics by benchmark and genomic context
diff_cov_total_df <- diff_cov_df %>%
  group_by(bench_context, context_name) %>%
  summarise(
    bases_covered = sum(bases_covered),
    interval_bp = sum(interval_bp),
    .groups = "drop"
  ) %>%
  mutate(
    frac_cov = 1 - (bases_covered / interval_bp),
    bench_context = str_replace(bench_context, "/", "_"),
    context = context_name
  ) %>%
  separate(
    bench_context,
    into = c("bench_version", "ref", "var_type"),
    sep = "_"
  ) %>%
  select(-context_name)
```


```{r}
diff_cov_total_df %>%
  filter(
    ref != "CHM13v2.0",
    !(bench_version == "v5.0q" & var_type == "smvar" & ref == "GRCh38"),
    !(bench_version == "v5.0q" & var_type == "stvar" & ref == "GRCh37"),
  ) %>%
  ggplot() +
  geom_bar(
    aes(
      x = context,
      y = bases_covered,
      fill = glue::glue("{bench_version} {ref}")
    ),
    position = "dodge",
    stat = "identity"
  ) +
  facet_wrap(~var_type, ncol = 1) +
  theme_minimal() +
  labs(x = "Genomic Context", y = "Bases Included", fill = "Benchmark") +
  theme(legend.position = "bottom")
```


```{r}
diff_top_intervals <- diff_cov_df %>%
  filter(
    str_detect(bench_context, "GRCh38_smvar") |
      str_detect(bench_context, "GRCh37_stvar")
  ) %>%
  group_by(bench_context) %>%
  slice_max(order_by = interval_bp, n = 10000) %>%
  mutate(bench_context = str_replace(bench_context, "/", "_")) %>%
  separate(
    bench_context,
    into = c("bench_version", "ref", "var_type", "context"),
    sep = "_"
  )
```


```{r}
diff_top_intervals %>%
  filter(interval_bp > 5000) %>%
  arrange(frac_cov) %>%
  mutate(n_interval = cumsum(bases_covered)) %>%
  ggplot() +
  geom_path(aes(x = n_interval, y = frac_cov, color = bench_version)) +
  facet_grid(var_type ~ context)
```


```{r}
diff_cov_df %>%
  filter(
    str_detect(bench_context, "GRCh38_smvar") |
      str_detect(bench_context, "GRCh37_stvar")
  ) %>%
  mutate(
    fully_covered = if_else(num_overlap == 1 & frac_cov == 1.0, TRUE, FALSE)
  ) %>%
  group_by(bench_context, fully_covered) %>%
  summarise(diff_bp = sum(interval_bp)) %>%
  ungroup() %>%
  mutate(bench_context = str_replace(bench_context, "/", "_")) %>%
  separate(
    bench_context,
    into = c("bench_version", "ref", "var_type", "context"),
    sep = "_"
  ) %>%
  filter(fully_covered) %>%
  ggplot() +
  geom_bar(
    aes(x = context, fill = bench_version, y = diff_bp),
    stat = "identity",
    position = "dodge"
  ) +
  facet_wrap(~var_type, nrow = 1)

```