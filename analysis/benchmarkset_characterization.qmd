---
title: "v5q Benchmark Set Variant and Region Characterization"
date: '`r Sys.Date()`'
author: "ND Olson"
format:
  html:
    theme: flatly
    page-layout: full
    toc: true
    self-contained: true
editor: source
code-fold: true
execute:
  warning: false
---

```{r setup}
#| include=FALSE,
#| echo=TRUE
library(tidyverse)
library(sessioninfo)
library(here)
library(assertthat)
library(patchwork)
library(gt)

# Load shared data loading functions
source(here("R/data_loading.R"))
source(here("R/plot_themes.R"))
```

## Data Loading

This analysis uses **primary aggregated metrics** rather than loading full variant tables directly. This approach is faster, more memory-efficient, and sufficient for most analyses. See the [Pipeline Outputs Reference](../docs/pipeline-outputs.md) for details on when to load detailed variant tables.

### Primary Metrics (Recommended)

```{r load_primary}
# Load variant tables for variant counts and size distribution analyses
variants_df <- load_all_variant_tables()

# Load aggregated genomic context metrics with variant counts
# One row per genomic context per benchmark
genomic_context_metrics_df <- load_genomic_context_metrics()

# Load reference genome sizes for normalization
ref_sizes_df <- load_reference_sizes()
total_ref_asm_bp <- ref_sizes_df %>%
  group_by(ref) %>%
  summarise(total_asm_bp = sum(atgcs), .groups = "drop")

hg002q100_size <- load_hg002q100_size()

# Load benchmark region files for downstream analysis
# Load benchmark region files using shared function (with factored variables)
bench_regions_df <- load_benchmark_regions()
```


### Data Verification

```{r data_verification}
# Parse pipeline config for expected values (dynamic, not hardcoded)
pipeline_config <- parse_pipeline_config()

expected_benchmarks <- pipeline_config$num_benchmarks
expected_contexts <- pipeline_config$num_contexts
expected_rows <- expected_benchmarks * expected_contexts

assertthat::assert_that(
  nrow(genomic_context_metrics_df) >= expected_rows - 5,
  msg = glue::glue(
    "Expected {expected_rows} or more rows in genomic_context_metrics_df, ",
    "got {nrow(genomic_context_metrics_df)} (from config: {expected_benchmarks} benchmarks × {expected_contexts} contexts)"
  )
)

# Verify all required genomic contexts are present
required_contexts <- c("HP", "MAP", "SD", "SD10kb", "TR", "TR10kb")
assertthat::assert_that(
  all(required_contexts %in% levels(genomic_context_metrics_df$context_name)),
  msg = "Missing expected genomic context names"
)

# Verify variant counts are non-negative
assertthat::assert_that(
  all(genomic_context_metrics_df$total_variants >= 0),
  msg = "Found negative variant counts"
)
```

### Key Data Frames for Analysis

These data frames are the primary inputs for downstream analyses:

**genomic_context_metrics_df** - Aggregated metrics with variant counts
- One row per genomic context per benchmark
- Contains: variant counts by type, coverage metrics, variant density
- Use for: variant count comparisons, density calculations, coverage analysis
- Columns: `bench_version`, `ref`, `bench_type`, `context_name`, `total_variants`, `snv_count`, `indel_count`, `del_count`, `ins_count`, `complex_count`, `variant_density_per_mb`
- **Variables are pre-factored** with standard levels (no manual factoring needed)

**bench_regions_df** - Benchmark region intervals
- All intervals from benchmark BED files with standardized format
- Use for: coverage calculations, interval size distributions, spatial analysis
- Columns: `chrom`, `start`, `end`, `interval_size`, `bench_version`, `ref`, `bench_type`
- **Variables are pre-factored** with standard levels (chromosomes, benchmark versions, references)

**ref_sizes_df** - Reference genome sizes
- Chromosome-level sizes and N-content
- Use for: percentage calculations, normalization, completeness assessment
- Columns: `ref`, `chrom`, `length`, `ns`, `asm_bp`

### Note on Full Variant Data

If variant-level detail is required (analyzing specific variant properties, edge cases, etc.), full variant tables can be loaded using:

```r
variants <- load_variant_table(
  "v5.0q_GRCh38_smvar",
  filters = list(
    chromosomes = c("chr1", "chr2"),  # Reduce memory usage
    variant_types = c("SNP", "INDEL"),
    in_benchmark_only = TRUE
  )
)
```

However, this is significantly slower (minutes) and memory-intensive (~1 GB), so use only when aggregate metrics are insufficient.

## Benchmark Set Summary Table

```{r}
bench_region_stats_df <- bench_regions_df %>%
  filter(
    bench_version %in% c("v5.0q"),
    chrom %in% paste0("chr", c(1:22, "X", "Y"))
  ) %>%
  group_by(bench_type, ref, bench_version) %>%
  summarise(total_bp = sum(interval_size), .groups = "drop") %>%
  left_join(total_ref_asm_bp) %>%
  mutate(
    pct_ref_cvg = round(100 * (total_bp / total_asm_bp), 0),
    pct_q100_cvg = round(100 * (total_bp / hg002q100_size), 0)
  ) %>%
  select(-total_asm_bp)

bench_var_cnt_df <- variants_df %>%
  filter(bench_version == "v5.0q") %>%
  group_by(bench_type, ref) %>%
  count(bench_type, ref, bench_version, var_type) %>%
  ungroup() %>%
  pivot_wider(
    names_from = var_type,
    values_from = n
  )
```

```{r}
full_join(bench_var_cnt_df, bench_region_stats_df) %>%
  select(-bench_version) %>%
  ungroup() %>%
  gt::gt(caption = "v5.0q Benchmark Summary Statistics") %>%
  gt::fmt_integer(
    columns = c(contains("var"), total_bp)
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_type"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_type = "Benchmark Type",
    # var_type = "Variant Subtype",
    # n = "Variant Count",
    total_bp = "Benchmark Bases",
    pct_ref_cvg = "% Ref. Cov.",
    pct_q100_cvg = "% Asm. Cov."
  ) %>%
  theme_gt_manuscript()
```


## Variant Counts


### Small Variant Counts

```{r small_variant_counts}
# Aggregate small variant counts by variant type
smvar_cnt_df <- variants_df %>%
  filter(bench_type == "smvar") %>%
  count(bench_type, ref, bench_version, var_type) %>%
  pivot_wider(names_from = var_type, values_from = n, values_fill = 0) %>%
  rename(SNV = SNP) %>%
  select(bench_type, ref, bench_version, SNV, INDEL) %>%
  mutate(Total = SNV + INDEL)
```

```{r small_variant_counts_table}
smv_cnt_tbl <- smvar_cnt_df %>%
  arrange(ref) %>%
  ungroup() %>%
  gt::gt(caption = "Number of indels (<50bp), single nucleotide variants (SNV) and total small variants by benchmark set.") %>%
  gt::fmt_integer(
    columns = c(SNV, INDEL, Total)
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_version"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_version = "Benchmark",
    SNV = "Single Nucleotide Variants (SNVs)",
    INDEL = "Insertions/Deletions",
    Total = "Total Variants"
  )

```

### Structural Variant Counts

```{r structural_variant_counts}
# Aggregate structural variant counts by type across all genomic contexts
stvar_cnt_df <- variants_df %>%
  filter(bench_type == "stvar") %>%
  count(bench_type, ref, bench_version, var_type) %>%
  pivot_wider(names_from = var_type, values_from = n, values_fill = 0) %>%
  mutate(Total = INS + DEL)

stvar_cnt_table <- stvar_cnt_df %>%
  arrange(ref) %>%
  ungroup() %>%
  gt::gt(
    caption = "Number of insertion, deletion, and total structural variants (≥50bp) by benchmark set."
  ) %>%
  gt::fmt_integer(
    columns = c(INS, DEL, Total)
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_version"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_version = "Benchmark"
  )

stvar_cnt_table
```

## Variant Size Distributions

**Note:** This section loads full variant-level data (large files, several minutes to load). These analyses require variant-level granularity and cannot be computed from aggregated metrics.


```{r sv_length_distribution}
#| message: true
# Load structural variant data for selected benchmarks
# This loads full variant tables for size distribution analysis
message("Loading full variant tables for size distribution analysis...")
message("This may take several minutes as files are large (~1 GB)...")

sv_len_df <- variants_df %>%
  filter(
    bench_version %in% c("v5.0q", "v0.6"),
    bench_type == "stvar"
  ) %>%
  select(bench_version, bench_type, ref, chrom, pos, var_size)

(sv_len_dist_plt <- ggplot(
  sv_len_df,
  aes(x = var_size)
) +
  geom_histogram(
    data = filter(sv_len_df, bench_version != "v0.6"),
    fill = "grey80",
    color = "grey20",
    bins = 100,
    drop = "all"
  ) +
  geom_histogram(
    data = filter(sv_len_df, bench_version == "v0.6"),
    fill = "grey30",
    color = "grey20",
    bins = 100,
    drop = "all"
  ) +
  scale_x_continuous(
    breaks = c(
      -10000,
      -5000,
      -1000,
      -500,
      -100,
      -50,
      0,
      50,
      100,
      500,
      1000,
      5000,
      10000
    ),
    trans = scales::pseudo_log_trans(sigma = 50, base = 10),
    labels = scales::comma
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "SV Length (bp)",
    y = "Count"
  ) +
  facet_wrap(~ref, ncol = 1) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = -45, hjust = 0)
  ))
```

```{r save_sv_length_distribution}
ggsave(
    filename = here("manuscript", "figs", "sv_length_distribution.png"),
    plot = sv_len_dist_plt,
    width = 8,
    height = 6,
    dpi = 300
)
```

```{r indel_length_distribution}
#| message: true
#| warning: false
# Load small variant data for selected benchmarks

smvar_benchmarks <- c(
  "v5.0q_GRCh38_smvar",
  "v5.0q_GRCh37_smvar",
  "v4.2.1_GRCh38_smvar"
)

smvar_len_df <- variants_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1"),
    bench_type == "smvar",
    var_type == "INDEL"
  ) %>%
  select(bench_version, bench_type, ref, chrom, pos, var_size)

(smvar_len_dist_plt <- ggplot(
  smvar_len_df,
  aes(x = var_size)
) +
  geom_histogram(
    data = filter(smvar_len_df, bench_version != "v4.2.1"),
    fill = "grey80",
    color = "grey20",
    binwidth = 1,
    drop = "all"
  ) +
  geom_histogram(
    data = filter(smvar_len_df, bench_version == "v4.2.1"),
    fill = "grey30",
    color = "grey20",
    binwidth = 1,
    drop = "all"
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "INDEL Length (bp)",
    y = "Count"
  ) +
  facet_wrap(~ref, ncol = 1) +
  theme_minimal())
```


## Variants in Difficult Genomic Contexts

This section visualizes variant counts by genomic context region, created from aggregated metrics (no full variant loading needed).

```{r variant_counts_by_context}
# Create variant count breakdown by genomic context from aggregated metrics
genomic_context_var_df <- variants_df %>% 
  filter(context_ids %in% c("HP", "MAP", "SD", "TR")) %>%
  count(bench_version, ref, bench_type, var_type, context_ids, name = "count")

```

```{r variant_counts_by_context_plot}
bench_version_cols <- c(
  "v5.0q" = "darkgreen",
  "v4.2.1" = "darkorange",
  "v0.6" = "purple"
)

(genomic_context_smvar_plt <- genomic_context_var_df  %>%
  filter(bench_type == "smvar") %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v5.0q", "v4.2.1", "v0.6")
    )
  ) %>%
  ggplot() +
  geom_bar(
    aes(
      x = var_type,
      y = count,
      fill = bench_version
    ),
    color = "grey20",
    position = "dodge",
    stat = "identity",
    show.legend = TRUE
  ) +
  facet_wrap(. ~ context_ids, nrow = 1) +
  scale_y_continuous(label = scales::label_comma()) +
  scale_fill_manual(
    name = "Benchmark Version",
    values = bench_version_cols,
    breaks = c("v5.0q", "v4.2.1", "v0.6"),
    drop = FALSE
  ) +
  labs(x = "Variant Type", y = "Variant Count") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = -45, vjust = 1)
  ))
```

```{r structural_variant_counts_by_context_plot}
(genomic_context_stvar_plt <- genomic_context_var_df  %>%
  filter(bench_type == "stvar", .preserve = TRUE) %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v5.0q", "v4.2.1", "v0.6")
    )
  ) %>%
  ggplot() +
  geom_bar(
    aes(x = var_type, y = count, fill = bench_version),
    color = "grey20",
    position = "dodge",
    stat = "identity",
    show.legend = TRUE
  ) +
  facet_wrap(. ~ context_ids, nrow = 1) +
  scale_y_continuous(label = scales::label_comma()) +
  scale_fill_manual(
    name = "Benchmark Version",
    values = bench_version_cols,
    breaks = c("v5.0q", "v4.2.1", "v0.6"),
    labels = c("v5.0q", "v4.2.1", "v0.6"),
    drop = FALSE
  ) +
  labs(x = "Variant Type", y = "Variant Count") +
  theme_minimal() +
  theme(legend.position = "bottom"))
```

```{r  combined_variant_counts_by_context_plot}
(combined_context_plt <- genomic_context_smvar_plt +
  genomic_context_stvar_plt +
  plot_layout(guides = , nrow = 2, ncol = 1) +
  plot_annotation(tag_levels = "A") %>%
    theme(
      legend.position = "bottom"
    ))

ggsave(
    filename = here("manuscript", "figs", "diff_variant_counts.png"),
    plot = diff_var_plt,
    width = 8,
    height = 6,
    dpi = 300,
)
```


```{r variant_counts_by_context_fold_change}
genomic_context_var_fld_chg <- variants_df %>%
  mutate(
    var_size_bin = case_when(
      abs(var_size) < 15 ~ "<15bp",
      abs(var_size) < 50 ~ "15-49bp",
      abs(var_size) < 1001 ~ "50 - 1,000bp",
      abs(var_size) < 10001 ~ "1,001 - 10,000bp",
      TRUE ~ ">10kb"
    )
  ) %>%
  count(bench_version, ref, bench_type, var_type, var_size_bin, context_ids) %>%
  pivot_wider(
    names_from = bench_version,
    values_from = n,
    id_cols = c(ref, bench_type, var_type, var_size_bin, context_ids)
  ) %>%
  filter(
    !is.na(v0.6) | !is.na(v4.2.1),
    !(ref == "GRCh37" & bench_type == "smvar")
  ) %>%
  mutate(
    fold_chg = case_when(
      !is.na(v0.6) ~ v5.0q / v0.6,
      !is.na(v4.2.1) ~ v5.0q / v4.2.1,
      TRUE ~ NA
    )
  )
```


```{r variant_counts_by_context_fold_change_plot_combined}
genomic_context_var_fld_chg %>%
  filter(context_ids %in% c("HP", "MAP", "SD", "TR")) %>%
  mutate(
    bench_type = factor(
      bench_type,
      levels = c("smvar", "stvar"),
      labels = c("Small Variants", "Structural Variants")
    )
  ) %>%
  ggplot() +
  geom_point(
    aes(
      x = context_ids,
      y = fold_chg,
      fill = var_size_bin,
      shape = var_type
    ),
    size = 4,
    color = "black",
    position = "jitterdodge"
  ) +
  facet_wrap(~bench_type, scales = "free", ncol = 1) +
  scale_shape_manual(
    values = c(21, 22, 23, 24),
    guide = guide_legend(override.aes = list(fill = "grey80"))
  ) +
  scale_fill_viridis_d(
    labels = c("<15bp", "15-49bp", "50bp-1kb", "1kb-10kb", ">10kb"),
    guide = guide_legend(override.aes = list(shape = 21))
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  labs(
    x = "Difficult Genomic Context",
    y = "Fold Change Variant Count",
    fill = "Variants Type",
    shape = "Benchmark Set"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical"
  )
```

## Benchmark region characterization

- Number of bases in benchmark regions in v5 compared to v4 and v0.6

### Total Included Base Comparisons

```{r}
bench_regions_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1", "v0.6"),
    chrom %in% paste0("chr", c(1:22, "X", "Y"))
  ) %>%
  group_by(bench_type, ref, bench_version) %>%
  summarise(total_bp = sum(interval_size), .groups = "drop") %>%
  left_join(total_ref_asm_bp) %>%
  mutate(
    pct_ref_cvg = round(100 * (total_bp / total_asm_bp), 0),
    pct_q100_cvg = round(100 * (total_bp / hg002q100_size), 0),
    total_bp = format(total_bp, big.mark = ",")
  ) %>%
  arrange(bench_type, bench_version, ref) %>%
  gt::gt()
```


### Relative changes between v5q and v4.2.1/v0.6 by chromosome
```{r fig.width = 8, fig.height = 4}
(coverage_change_plt <- regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref == "GRCh37"),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    select(-starts_with("X")) %>%
    group_by(var_type, chrom, bench_version) %>%
    summarise(total_size = sum(interval_size), .groups = "drop") %>%
    mutate(
        vers = if_else(bench_version == "v5.0q", "new", "old"),
        chrom = factor(chrom, levels = paste0("chr", 1:22))
    ) %>%
    select(-bench_version) %>%
    pivot_wider(names_from = vers, values_from = total_size) %>%
    mutate(
        pct_change = 100 * (new - old) / old,
        total_change = new - old
    ) %>%
    ggplot() +
    geom_hline(yintercept = 0, color = "grey50") +
    geom_point(
        aes(
            x = chrom,
            y = pct_change,
            fill = total_change / 1000000,
            shape = var_type
        ),
        size = 4,
        color = "black",
        position = "jitterdodge"
    ) +
    scale_y_continuous(
        labels = scales::percent_format(scale = 1),
        n.breaks = 10
    ) +
    scale_fill_gradient2(
        low = "red",
        mid = "white",
        high = "blue",
        midpoint = 0,
        labels = scales::comma
    ) +
    scale_shape_manual(values = c(21, 24)) +
    labs(
        x = "Chromosome",
        y = "Coverage Change",
        fill = "Coverage change (Mb)",
        shape = "Variant Type"
    ) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = -45, hjust = 0),
        legend.position = "bottom"
    ))
```

```{r}
(ggsave(
    filename = here("manuscript", "figs", "benchmark_region_size_change.png"),
    plot = coverage_change_plt,
    width = 8,
    height = 4,
    dpi = 300
))
```

### Inclusion of Difficult Regions

```{r eval=FALSE}
diff_coverage <- list.files(
    here("results/diff_region_coverage"),
    pattern = "_cov.bed",
    recursive = TRUE,
    full.names = TRUE
) %>%
    {
        set_names(
            .,
            str_extract(., "(?<=coverage/).*(?=_cov.bed)") %>%
                str_replace("/", "_")
        )
    } %>%
    map_dfr(
        read_tsv,
        col_names = c(
            "CHROM",
            "START",
            "END",
            "n_overlap",
            "bases_cov",
            "ivl_len",
            "frac_cov"
        ),
        col_types = "ciiiiid",
        .id = "strat"
    ) %>%
    filter(n_overlap > 0) %>%
    separate(
        strat,
        into = c("bench_version", "ref", "var_type", "strat"),
        sep = "_"
    )
```


```{r eval = FALSE}
diff_cov_total <- diff_coverage %>%
    group_by(bench_version, ref, var_type, strat) %>%
    summarise(total_cov = sum(bases_cov))

diff_cov_total %>%
    ggplot() +
    geom_bar(
        aes(x = strat, y = total_cov, fill = bench_version),
        stat = "identity",
        position = "dodge"
    ) +
    facet_wrap(~var_type, ncol = 1) +
    theme_minimal()
```

#### Difficult Region Bases Included
Not sure how this is different from above - might just have been a renamed section and revised figures
```{r eval = FALSE}
(diff_included_tbl <- list.files(path = here("results/diff_region_coverage"), pattern = "_cov.bed$",recursive = TRUE, full.names = TRUE) %>% {tibble(file_path = .)} %>% 
   mutate(bench_id = str_extract(file_path, "(?<=diff_region_coverage/).*(?=/)"),
          diff_region = str_extract(file_path, "(?<=var/).*(?=_cov.bed)"))) %>% 
  
)
```


```{r eval = FALSE}

diff_included_plt_df <- diff_included_tbl %>%
    filter(
        (bench_version %in%
            c("v5q", "v421") &
            bench_type == "smvar" &
            ref_id == "grch38") |
            (bench_version %in%
                c("v5q", "v06") &
                bench_type == "stvar" &
                ref_id == "grch37"),
        chrom_scope == "autosomes"
    )
```

```{r eval=FALSE}
ggplot(diff_included_plt_df) +
    geom_point(
        aes(
            x = bench_type,
            y = overlap_bp,
            fill = context,
            shape = bench_version
        ),
        position = "jitterdodge"
    ) +
    scale_y_log10() +
    annotation_logticks(sides = "lr") +
    scale_shape_manual(values = c(21, 24, 22)) +
    labs(
        x = "Benchmark Type",
        y = "Included Bases (bp)",
        fill = "Genomic Context",
        shape = "Benchmark Version"
    ) +
    facet_wrap(~context, nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", legend.box = "vertical") +
    guides(
        fill = guide_legend(
            nrow = 2,
            byrow = TRUE,
            override.aes = list(shape = 21)
        )
    )
```

```{r eval=FALSE}
ggplot(
    diff_included_plt_df,
    aes(
        x = bench_type,
        y = included_pct
    )
) +
    geom_point(
        aes(
            fill = context,
            shape = bench_version
        ),
        position = position_jitterdodge(dodge.width = 0.5)
    ) +
    scale_shape_manual(values = c(21, 24, 22)) +
    scale_color_manual(values = c("grey20", "darkred")) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    labs(
        x = "Benchmark Type",
        y = "Included Bases (%)",
        fill = "Genomic Context",
        shape = "Benchmark Version"
    ) +
    facet_wrap(~context, nrow = 1) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        legend.box = "vertical"
    ) +
    guides(
        fill = guide_legend(
            nrow = 2,
            byrow = TRUE,
            override.aes = list(shape = 21)
        )
    )
```

```{r eval = FALSE}
diff_included_plt_df %>%
    select(
        ref,
        bench_type,
        context,
        bench_version,
        chrom_scope,
        included_pct
    ) %>%
    filter(chrom_scope == "autosomes") %>%
    # group_by(bench_type) %>%
    # pivot_wider(names_from = bench_version, values_from = included_pct) #%>%
    # mutate(pct_change = (v5q - v421)/v421) %>%
    arrange(bench_type, context, chrom_scope) %>%
    gt::gt()
```


```{r eval = FALSE}
diff_var_fld_chg <- diff_var_plt_df %>%
  mutate(
    var_size_bin = case_when(
      abs(var_size) < 15 ~ "<15bp",
      abs(var_size) < 50 ~ "15-49bp",
      abs(var_size) < 1001 ~ "50 - 1,000bp",
      abs(var_size) < 10001 ~ "1,001 - 10,000bp",
      TRUE ~ ">10kb"
    )
  ) %>%
  count(bench_version, ref, bench_type, var_type, var_size_bin, strat_ids) %>%
  pivot_wider(
    names_from = bench_version,
    values_from = n,
    id_cols = c(ref, bench_type, var_type, var_size_bin, strat_ids)
  ) %>%
  filter(
    !is.na(v0.6) | !is.na(v4.2.1),
    !(ref == "GRCh37" & bench_type == "smvar")
  ) %>%
  mutate(
    fold_chg = case_when(
      !is.na(v0.6) ~ v5.0q / v0.6,
      !is.na(v4.2.1) ~ v5.0q / v4.2.1,
      TRUE ~ NA
    )
  )
```


```{r}
diff_var_fld_chg %>%
  filter(strat_ids %in% c("HP", "MAP", "SD", "TR")) %>%
  mutate(
    bench_type = factor(
      bench_type,
      levels = c("smvar", "stvar"),
      labels = c("Small Variants", "Structural Variants")
    )
  ) %>%
  ggplot() +
  geom_point(
    aes(
      x = strat_ids,
      y = fold_chg,
      fill = var_size_bin,
      shape = var_type
    ),
    size = 4,
    color = "black",
    position = "jitterdodge"
  ) +
  facet_grid(bench_type ~ strat_ids, scales = "free") +
  scale_shape_manual(
    values = c(21, 22, 23, 24),
    guide = guide_legend(override.aes = list(fill = "grey80"))
  ) +
  scale_fill_viridis_d(
    labels = c("<15bp", "15-49bp", "50bp-1kb", "1kb-10kb", ">10kb"),
    guide = guide_legend(override.aes = list(shape = 21))
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  labs(
    x = "Difficult Genomic Context",
    y = "Fold Change Variant Count",
    fill = "Variants Type",
    shape = "Benchmark Set"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical"
  )
```

### Benchmark Interval Size Distributions

Platinum pedigree truthsets downloaded from aws using `aws s3 sync --no-sign-request s3://platinum-pedigree-data/truthset_v1.2/ . 
```{r}
(interval_size_dist_plt <- regions_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
    (var_type == "smvar" & ref == "GRCh38") |
      (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
    chrom %in% paste0("chr", c(1:22))
  ) %>%
  select(-starts_with("X")) %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v4.2.1", "v0.6", "v5.0q", "PP")
    ),
    var_type = case_when(
      var_type == "smvar" ~ "Small Variants",
      var_type == "stvar" ~ "Structural Variants"
    )
  ) %>%
  ggplot() +
  geom_density(
    aes(x = interval_size, fill = bench_version),
    position = "identity",
    kernel = "gaussian",
    alpha = 0.5,
    bw = "sj",
    adjust = 0.20,
    outline.type = "upper",
    trim = TRUE
  ) +
  scale_x_log10(labels = scales::comma) +
  annotation_logticks(sides = "b") +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~var_type, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(
    x = "Benchmark Interval Size (bp)",
    y = "Included Based",
    fill = "Benchmark Version"
  ))
```

```{r}
(interval_count_plt <- regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    ggplot() +
    geom_bar(
        aes(x = bench_version, fill = bench_version),
        color = "grey20",
        position = "dodge",
        alpha = 0.5
    ) +
    facet_wrap(~var_type, ncol = 2, scales = "free") +
    labs(
        x = "Benchmark Version",
        y = "Number of Intervals",
        fill = "Benchmark Version"
    ) +
    scale_y_continuous(labels = scales::comma) +
    theme_minimal() +
    theme(legend.position = "none"))
```

```{r}
(interval_plt <- interval_count_plt + 
    interval_size_dist_plt +
    plot_layout(ncol = 1))
```

```{r}
ggsave(
    here("manuscript/figs/benchmark_intervals.png"),
    interval_plt,
    width = 8,
    height = 6
)
```

Number of regions by benchmark set.
May want to include in summary table or part of a single large supplemental table
```{r eval = FALSE}
regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    group_by(bench_version, var_type, ref) %>%
    count() %>%
    mutate(
        bench_version = factor(
            bench_version,
            levels = c("v4.2.1", "v0.6", "v5.0q", "PP")
        )
    ) %>%
    arrange(var_type, bench_version) %>%
    ungroup() %>%
    select(var_type, ref, bench_version, n) %>%
    gt::gt() %>%
    gt::tab_header(title = "Number of intervals in Benchmark Regions") %>%
    gt::fmt_integer(columns = n) %>%
    gt::cols_align(
        columns = c("var_type", "ref", "bench_version"),
        align = "right"
    ) %>%
    gt::cols_label(
        var_type = "Variant Type",
        ref = "Reference",
        bench_version = "Benchmark",
        n = "Number of Intervals"
    )
```
