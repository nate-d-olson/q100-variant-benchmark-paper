---
title: "v5q Benchmark Set Variant and Region Characterization"
date: '`r Sys.Date()`'
author: "ND Olson"
format:
  html:
    theme: flatly
    page-layout: full
    toc: true
    self-contained: true
editor: source
code-fold: true
execute:
  warning: false
---

```{r setup}
#| include: false
source(here::here("analysis/_notebook_setup.R"))
analysis_setup(
  load_plot_themes = TRUE,
  load_sessioninfo = TRUE,
  load_gt = TRUE
)
```

## Data Loading

This analysis uses **primary aggregated metrics** rather than loading full variant tables directly. This approach is faster, more memory-efficient, and sufficient for most analyses. See the [Pipeline Outputs Reference](../docs/pipeline-outputs.md) for details on when to load detailed variant tables.

### Primary Metrics (Recommended)

```{r load_primary}
analysis_data <- load_primary_analysis_data(
  include_variants = TRUE,
  include_reference_sizes = TRUE,
  include_hg002q100_size = TRUE,
  include_benchmark_regions = TRUE
)
list2env(analysis_data, envir = environment())

## Filtering variants_df to benchmark regions for the characterization
variants_df <- variants_df %>% filter(region_ids == "BMKREGIONS")
```


### Key Data Frames for Analysis

These data frames are the primary inputs for downstream analyses:

**genomic_context_metrics_df** - Aggregated metrics with variant counts
- One row per genomic context per benchmark
- Contains: variant counts by type, coverage metrics, variant density
- Use for: variant count comparisons, density calculations, coverage analysis
- Columns: `bench_version`, `ref`, `bench_type`, `context_name`, `total_variants`, `snv_count`, `indel_count`, `del_count`, `ins_count`, `complex_count`, `variant_density_per_mb`
- **Variables are pre-factored** with standard levels (no manual factoring needed)

**bench_regions_df** - Benchmark region intervals
- All intervals from benchmark BED files with standardized format
- Use for: coverage calculations, interval size distributions, spatial analysis
- Columns: `chrom`, `start`, `end`, `interval_size`, `bench_version`, `ref`, `bench_type`
- **Variables are pre-factored** with standard levels (chromosomes, benchmark versions, references)

**ref_sizes_df** - Reference genome sizes
- Chromosome-level sizes and N-content
- Use for: percentage calculations, normalization, completeness assessment
- Columns: `ref`, `chrom`, `length`, `ns`, `asm_bp`

### Note on Full Variant Data

If variant-level detail is required (analyzing specific variant properties, edge cases, etc.), full variant tables can be loaded using:

```r
variants <- load_variant_table(
  "v5.0q_GRCh38_smvar",
  filters = list(
    chromosomes = c("chr1", "chr2"),  # Reduce memory usage
    variant_types = c("SNV", "INDEL"),
    in_benchmark_only = TRUE
  )
)
```

However, this is significantly slower (minutes) and memory-intensive (~1 GB), so use only when aggregate metrics are insufficient.

## Benchmark Set Summary Table

```{r}
bench_region_stats_df <- bench_regions_df %>%
  filter(
    bench_version %in% c("v5.0q"),
    chrom %in% CHROM_LEVELS
  ) %>%
  group_by(bench_type, ref, bench_version) %>%
  summarise(total_bp = sum(interval_size), .groups = "drop") %>%
  left_join(total_ref_asm_bp) %>%
  mutate(
    pct_ref_cvg = round(100 * (total_bp / total_asm_bp), 0),
    pct_q100_cvg = round(100 * (total_bp / hg002q100_size), 0)
  ) %>%
  select(-total_asm_bp)

bench_var_cnt_df <- variants_df %>%
  filter(bench_version == "v5.0q") %>%
  group_by(bench_type, ref) %>%
  count(bench_type, ref, bench_version, var_type) %>%
  ungroup() %>%
  pivot_wider(
    names_from = var_type,
    values_from = n
  )
```

```{r}
full_join(bench_var_cnt_df, bench_region_stats_df) %>%
  select(-bench_version) %>%
  ungroup() %>%
  mutate(ref = std_references(ref)) %>%
  arrange(bench_type, ref) %>%
  group_by(bench_type) %>%
  gt::gt() %>%
  gt::fmt_integer(
    columns = c(SNV, INDEL, INS, DEL, total_bp)
  ) %>%
  gt::sub_missing(
    missing_text = ""
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_type"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_type = "Benchmark Type",
    total_bp = "Benchmark Bases",
    pct_ref_cvg = "% Ref. Cov.",
    pct_q100_cvg = "% Asm. Cov."
  ) %>%
  gt::cols_move(
    columns = c("SNV", "INDEL", "INS", "DEL"),
    after = "ref"
  ) %>%
  theme_gt_manuscript()
```

## Variant Size Distributions


```{r sv_length_distribution}
#| message: true
# Load structural variant data for selected benchmarks
# This loads full variant tables for size distribution analysis

stvar_len_df <- variants_df %>%
  filter(
    bench_version %in% c("v5.0q", "v0.6"),
    bench_type == "stvar"
  ) %>%
  mutate(ref = std_references(ref)) %>%
  select(bench_version, bench_type, ref, chrom, pos, var_size)

(stvar_len_dist_plt <- ggplot(
  stvar_len_df,
  aes(x = var_size)
) +
  geom_histogram(
    data = filter(stvar_len_df, bench_version != "v0.6"),
    fill = "grey80",
    color = "grey20",
    bins = 100,
    drop = "all"
  ) +
  geom_histogram(
    data = filter(stvar_len_df, bench_version == "v0.6"),
    fill = "grey30",
    color = "grey20",
    bins = 100,
    drop = "all"
  ) +
  scale_x_continuous(
    breaks = c(
      -10000,
      -5000,
      -1000,
      -500,
      -100,
      -50,
      0,
      50,
      100,
      500,
      1000,
      5000,
      10000
    ),
    trans = scales::pseudo_log_trans(sigma = 50, base = 10),
    labels = scales::comma
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "SV Length (bp)",
    y = "Count"
  ) +
  facet_wrap(~ref, ncol = 1) +
  theme_manuscript() +
  theme(
    axis.text.x = element_text(angle = -45, hjust = 0)
  ))
```

```{r indel_length_distribution}
#| message: true
#| warning: false
# Load small variant data for selected benchmarks

smvar_len_df <- variants_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1"),
    bench_type == "smvar",
    var_type == "INDEL"
  ) %>%
  mutate(ref = std_references(ref)) %>%
  select(bench_version, bench_type, ref, chrom, pos, var_size)

(smvar_len_dist_plt <- ggplot(
  smvar_len_df,
  aes(x = var_size)
) +
  geom_histogram(
    data = filter(smvar_len_df, bench_version != "v4.2.1"),
    fill = "grey80",
    color = "grey20",
    binwidth = 1,
    drop = "all"
  ) +
  geom_histogram(
    data = filter(smvar_len_df, bench_version == "v4.2.1"),
    fill = "grey30",
    color = "grey20",
    binwidth = 1,
    drop = "all"
  ) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    x = "INDEL Length (bp)",
    y = "Count"
  ) +
  facet_wrap(~ref, ncol = 1) +
  theme_manuscript())
```

```{r}
(combined_var_len_dist_plt <- (smvar_len_dist_plt) +
  (stvar_len_dist_plt) +
  plot_layout(
    ncol = 2,
    guides = "collect",
    widths = c(1, 2)
  ) +
  plot_annotation(tag_levels = "A") &
  theme_manuscript() +
    theme(
      axis.text.x = element_text(angle = -45, hjust = 0),
      plot.margin = unit(c(5, 5, 5, 5), "pt")
    ))
```

```{r var_length_dist_save}
ggsave(
  filename = here("manuscript", "figs", "var_len_dist.png"),
  plot = combined_var_len_dist_plt,
  width = 8,
  height = 4,
  dpi = 300
)
```



## Benchmark region characterization

- Number of bases in benchmark regions in v5 compared to v4 and v0.6

### Relative changes between v5q and v4.2.1/v0.6 by chromosome
```{r fig.width = 8, fig.height = 4}
(coverage_change_plt <- bench_regions_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1", "v0.6"),
    (bench_type == "smvar" & ref == "GRCh38") |
      (bench_type == "stvar" & ref == "GRCh37"),
    chrom %in% AUTOSOME_CHROM_LEVELS
  ) %>%
  select(-starts_with("X")) %>%
  group_by(bench_type, chrom, bench_version) %>%
  summarise(total_size = sum(interval_size), .groups = "drop") %>%
  mutate(
    vers = if_else(bench_version == "v5.0q", "new", "old"),
    chrom = factor(chrom, levels = AUTOSOME_CHROM_LEVELS)
  ) %>%
  select(-bench_version) %>%
  pivot_wider(names_from = vers, values_from = total_size) %>%
  mutate(
    pct_change = 100 * (new - old) / old,
    total_change = new - old
  ) %>%
  ggplot() +
  geom_hline(yintercept = 0, color = "grey50") +
  geom_point(
    aes(
      x = chrom,
      y = pct_change,
      fill = total_change / 1000000,
      shape = bench_type
    ),
    size = 4,
    color = "black",
    position = "jitterdodge"
  ) +
  scale_y_continuous(
    labels = scales::percent_format(scale = 1),
    n.breaks = 10
  ) +
  scale_fill_gradient2(
    low = "red",
    mid = "white",
    high = "blue",
    midpoint = 0,
    labels = scales::comma
  ) +
  scale_shape_manual(values = c(21, 24)) +
  labs(
    x = "Chromosome",
    y = "Coverage Change",
    fill = "Coverage change (Mb)",
    shape = "Variant Type"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = -45, hjust = 0),
    legend.position = "bottom"
  ))
```

```{r}
(ggsave(
  filename = here("manuscript", "figs", "benchmark_region_size_change.png"),
  plot = coverage_change_plt,
  width = 8,
  height = 4,
  dpi = 300
))
```
