---
title: "v5q Benchmark Set Variant and Region Characterization"
date: '`r Sys.Date()`'
author: "ND Olson"
format:
  html:
    theme: flatly
    page-layout: full
    toc: true
    self-contained: true
editor: source
code-fold: true
execute:
  warning: false
---

```{r setup}
#| include=FALSE,
#| echo=TRUE
library(tidyverse)
library(sessioninfo)
library(here)
library(assertthat)
library(patchwork)
library(gt)

# Load shared data loading functions
source(here("R/data_loading.R"))
```

## Data Loading

This analysis uses **primary aggregated metrics** rather than loading full variant tables directly. This approach is faster, more memory-efficient, and sufficient for most analyses. See the [Pipeline Outputs Reference](../docs/pipeline-outputs.md) for details on when to load detailed variant tables.

### Primary Metrics (Recommended)

```{r}
# Load aggregated stratification metrics with variant counts
# One row per stratification per benchmark
strat_metrics_df <- load_stratification_metrics()

# Load reference genome sizes for normalization
ref_sizes_df <- load_reference_sizes()

# Load benchmark region files for downstream analysis
# Load benchmark region files using shared function (with factored variables)
bench_regions_df <- load_benchmark_regions()
```

### Data Verification

```{r}
# Parse pipeline config for expected values (dynamic, not hardcoded)
pipeline_config <- parse_pipeline_config()

expected_benchmarks <- pipeline_config$num_benchmarks
expected_strats <- pipeline_config$num_stratifications
expected_rows <- expected_benchmarks * expected_strats

assertthat::assert_that(
  nrow(strat_metrics_df) >= expected_rows - 5,
  msg = glue::glue(
    "Expected {expected_rows} or more rows in strat_metrics_df, ",
    "got {nrow(strat_metrics_df)} (from config: {expected_benchmarks} benchmarks × {expected_strats} strats)"
  )
)

# Verify all required stratifications are present
required_strats <- c("HP", "MAP", "SD", "SD10kb", "TR", "TR10kb")
assertthat::assert_that(
  all(required_strats %in% levels(strat_metrics_df$strat_name)),
  msg = "Missing expected stratification names"
)

# Verify variant counts are non-negative
assertthat::assert_that(
  all(strat_metrics_df$total_variants >= 0),
  msg = "Found negative variant counts"
)
```

### Key Data Frames for Analysis

These data frames are the primary inputs for downstream analyses:

**strat_metrics_df** - Aggregated metrics with variant counts
- One row per stratification per benchmark
- Contains: variant counts by type, coverage metrics, variant density
- Use for: variant count comparisons, density calculations, coverage analysis
- Columns: `bench_version`, `ref`, `bench_type`, `strat_name`, `total_variants`, `snv_count`, `indel_count`, `del_count`, `ins_count`, `complex_count`, `variant_density_per_mb`
- **Variables are pre-factored** with standard levels (no manual factoring needed)

**bench_regions_df** - Benchmark region intervals
- All intervals from benchmark BED files with standardized format
- Use for: coverage calculations, interval size distributions, spatial analysis
- Columns: `chrom`, `start`, `end`, `interval_size`, `bench_version`, `ref`, `bench_type`
- **Variables are pre-factored** with standard levels (chromosomes, benchmark versions, references)

**ref_sizes_df** - Reference genome sizes
- Chromosome-level sizes and N-content
- Use for: percentage calculations, normalization, completeness assessment
- Columns: `ref`, `chrom`, `length`, `ns`, `asm_bp`

### Note on Full Variant Data

If variant-level detail is required (analyzing specific variant properties, edge cases, etc.), full variant tables can be loaded using:

```r
variants <- load_variant_table(
  "v5.0q_GRCh38_smvar",
  filters = list(
    chromosomes = c("chr1", "chr2"),  # Reduce memory usage
    variant_types = c("SNP", "INDEL"),
    in_benchmark_only = TRUE
  )
)
```

However, this is significantly slower (minutes) and memory-intensive (~1 GB), so use only when aggregate metrics are insufficient.

## Variant Counts

### Small Variant Counts

```{r}
# Aggregate small variant counts by type across all stratifications
# Note: snv_count is renamed from snp_count in load_stratification_metrics()
smvar_cnt_df <- strat_metrics_df %>%
  filter(bench_type == "smvar") %>%
  group_by(bench_type, ref, bench_version) %>%
  summarise(
    SNV = sum(snv_count),
    INDEL = sum(indel_count),
    .groups = "drop"
  ) %>%
  mutate(Total = SNV + INDEL)

smvar_cnt_df
```

```{r}
smv_cnt_tbl <- smvar_cnt_df %>%
  arrange(ref) %>%
  ungroup() %>%
  gt::gt(caption = "Number of indels (<50bp), single nucleotide variants (SNV) and total small variants by benchmark set.") %>%
  gt::fmt_integer(
    columns = c(SNV, INDEL, Total)
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_version"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_version = "Benchmark",
    SNV = "Single Nucleotide Variants (SNVs)",
    INDEL = "Insertions/Deletions",
    Total = "Total Variants"
  )

smv_cnt_tbl
```

### Structural Variant Counts

```{r}
# Aggregate structural variant counts by type across all stratifications
stvar_cnt_df <- strat_metrics_df %>%
  filter(bench_type == "stvar") %>%
  group_by(bench_type, ref, bench_version) %>%
  summarise(
    INS = sum(ins_count),
    DEL = sum(del_count),
    .groups = "drop"
  ) %>%
  mutate(Total = INS + DEL)

stvar_cnt_table <- stvar_cnt_df %>%
  arrange(ref) %>%
  ungroup() %>%
  gt::gt(caption = "Number of insertion, deletion, and total structural variants (≥50bp) by benchmark set.") %>%
  gt::fmt_integer(
    columns = c(INS, DEL, Total)
  ) %>%
  gt::cols_align(
    columns = c("ref", "bench_version"),
    align = "right"
  ) %>%
  gt::cols_label(
    ref = "Reference",
    bench_version = "Benchmark"
  )

stvar_cnt_table
```
```

### Combined Variant Table

```{r}
# Create variant type breakdown for combined table (v5.0q only)
combined_var_cnt_df <- strat_metrics_df %>%
  filter(bench_version == "v5.0q") %>%
  group_by(bench_type, ref) %>%
  summarise(
    SNV = sum(snv_count),
    INDEL = sum(indel_count),
    INS = sum(ins_count),
    DEL = sum(del_count),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols = c(SNV, INDEL, INS, DEL),
    names_to = "var_type",
    values_to = "count"
  ) %>%
  pivot_wider(
    names_from = ref,
    values_from = count
  ) %>%
  mutate(var_type = factor(var_type, levels = c("SNV", "INDEL", "INS", "DEL"))) %>%
  arrange(bench_type, var_type)

var_cnt_gt <- gt(combined_var_cnt_df,
                 rowname_col = "var_type",
                 groupname_col = "bench_type") %>%
  tab_options(
    row_group.as_column = TRUE,
    table.border.bottom.style = "solid",
    stub_row_group.border.style = "hidden",
    stub.border.style = "hidden",
    row.striping.include_table_body = TRUE,
    row.striping.include_stub = TRUE,
    row.striping.background_color = "grey80"
  ) %>%
  tab_spanner(label = "Reference Genome",
              id = "ref_span",
              columns = c("GRCh37", "GRCh38", "CHM13v2.0")) %>%
  fmt_integer(
    columns = c(GRCh37, GRCh38, CHM13v2.0),
  ) %>%
  tab_stubhead(label = "Variant Type") %>%
  tab_row_group(
    label = "Structural Variants (>49bp)",
    rows = bench_type == "stvar",
    id = "stvar_group"
  ) %>%
  tab_row_group(
    label = "Small Variants (<50bp)",
    rows = bench_type == "smvar",
    id = "smvar_group"
  ) %>% 
  summary_rows(
    groups = everything(),
    columns = c("GRCh37", "GRCh38", "CHM13v2.0"),
    fns = list(Total = ~ sum(., na.rm = TRUE)),
    fmt = ~ fmt_integer(.) 
  ) 

var_cnt_gt
```


```{r}
table_dir <- here("manuscript", "tables")
if (!dir.exists(table_dir)) {
    dir.create(table_dir, recursive = TRUE)
}

gtsave(
    var_cnt_gt,
    filename = here("manuscript", "tables", "variant_counts_table.docx")
)
```

## Variant Size Distributions

**Note:** This section loads full variant-level data (large files, several minutes to load). These analyses require variant-level granularity and cannot be computed from aggregated metrics.

FIXME - deletions missing for v0.6

```{r}
#| message: true
# Load structural variant data for selected benchmarks
# This loads full variant tables for size distribution analysis
message("Loading full variant tables for size distribution analysis...")
message("This may take several minutes as files are large (~1 GB)...")

sv_benchmarks <- c(
  "v5.0q_GRCh38_stvar",
  "v5.0q_GRCh37_stvar",
  "v0.6_GRCh37_stvar"
)

sv_len_df <- sv_benchmarks %>%
  map_dfr(
    ~ {
      message(glue::glue("Loading {.x}..."))
      load_variant_table(.x) %>%
        select(chrom, pos, len_ref, len_alt) %>%
        mutate(
          var_size = len_alt - len_ref,
          bench_id = .x
        ) %>%
        select(bench_id, var_size)
    }
  ) %>%
  separate(bench_id, into = c("bench_version", "ref", "bench_type"), sep = "_") %>%
  mutate(ref = factor(ref, levels = c("GRCh37", "GRCh38", "CHM13v2.0")))

(sv_len_dist_plt <- ggplot(
    sv_len_df,
    aes(x = var_size)
) +
    geom_histogram(
        data = filter(sv_len_df, bench_version != "v0.6"),
        fill = "grey80",
        color = "grey20",
        bins = 100,
        drop = "all"
    ) +
    geom_histogram(
        data = filter(sv_len_df, bench_version == "v0.6"),
        fill = "grey30",
        color = "grey20",
        bins = 100,
        drop = "all"
    ) +
    scale_x_continuous(
        breaks = c(
            -10000,
            -5000,
            -1000,
            -500,
            -100,
            -50,
            0,
            50,
            100,
            500,
            1000,
            5000,
            10000
        ),
        trans = scales::pseudo_log_trans(sigma = 50, base = 10),
        labels = scales::comma
    ) +
    scale_y_continuous(labels = scales::comma) +
    labs(
        x = "SV Length (bp)",
        y = "Count"
    ) +
    facet_wrap(~ref, ncol = 1) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = -45, hjust = 0)
    ))
```

```{r}
ggsave(
    filename = here("manuscript", "figs", "sv_length_distribution.png"),
    plot = sv_len_dist_plt,
    width = 8,
    height = 6,
    dpi = 300
)
```

```{r}
#| message: true
#| warning: false
# Load small variant data for selected benchmarks
message("Loading full variant tables for indel size analysis...")

smvar_benchmarks <- c(
  "v5.0q_GRCh38_smvar",
  "v5.0q_GRCh37_smvar",
  "v4.2.1_GRCh38_smvar"
)

smvar_len_df <- smvar_benchmarks %>%
  map_dfr(
    ~ {
      message(glue::glue("Loading {.x}..."))
      load_variant_table(.x) %>%
        filter(var_type == "INDEL") %>%
        select(chrom, pos, len_ref, len_alt) %>%
        mutate(
          var_size = len_alt - len_ref,
          bench_id = .x
        ) %>%
        select(bench_id, var_size)
    }
  ) %>%
  separate(bench_id, into = c("bench_version", "ref", "bench_type"), sep = "_") %>%
  mutate(ref = factor(ref, levels = c("GRCh37", "GRCh38", "CHM13v2.0")))

(smvar_len_dist_plt <- ggplot(
    smvar_len_df,
    aes(x = var_size)
) +
    geom_histogram(
        data = filter(smvar_len_df, bench_version != "v4.2.1"),
        fill = "grey80",
        color = "grey20",
        binwidth = 1,
        drop = "all"
    ) +
    geom_histogram(
        data = filter(smvar_len_df, bench_version == "v4.2.1"),
        fill = "grey30",
        color = "grey20",
        binwidth = 1,
        drop = "all"
    ) +
    scale_y_continuous(labels = scales::comma) +
    labs(
        x = "INDEL Length (bp)",
        y = "Count"
    ) +
    facet_wrap(~ref, ncol = 1) +
    theme_minimal())
```


## Variants in Difficult Genomic Contexts

This section visualizes variant counts by stratification region, created from aggregated metrics (no full variant loading needed).

```{r}
# Create variant count breakdown by stratification from aggregated metrics
diff_var_plt_df <- strat_metrics_df %>%
  # Expand variant counts to individual rows by type
  pivot_longer(
    cols = c(snv_count, indel_count, del_count, ins_count, complex_count, other_count),
    names_to = "count_type",
    values_to = "count"
  ) %>%
  mutate(
    var_type = case_when(
      count_type == "snv_count" ~ "SNV",
      count_type == "indel_count" ~ "INDEL",
      count_type == "del_count" ~ "DEL",
      count_type == "ins_count" ~ "INS",
      count_type == "complex_count" ~ "COMPLEX",
      count_type == "other_count" ~ "OTHER",
      TRUE ~ "UNKNOWN"
    ),
    strat_ids = strat_name  # Use stratification name as grouping variable
  ) %>%
  filter(count > 0) %>%  # Only non-zero counts
  select(-count_type)
```

```{r}
bench_version_cols <- c(
  "v5.0q" = "darkgreen",
  "v4.2.1" = "darkorange",
  "v0.6" = "purple"
)

(diff_smvar_plt <- diff_var_plt_df %>%
  filter(bench_type == "smvar") %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v5.0q", "v4.2.1", "v0.6")
    )
  ) %>%
  ggplot() +
  geom_bar(
    aes(
      x = var_type,
      y = count,
      fill = bench_version
    ),
    color = "grey20",
    position = "dodge",
    stat = "identity",
    show.legend = TRUE
  ) +
  facet_wrap(. ~ strat_ids, nrow = 1) +
  scale_y_continuous(label = scales::label_comma()) +
  scale_fill_manual(
    name = "Benchmark Version",
    values = bench_version_cols,
    breaks = c("v5.0q", "v4.2.1", "v0.6"),
    drop = FALSE
  ) +
  labs(x = "Variant Type", y = "Variant Count") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = -45, vjust = 1)
  ))
```

```{r}
(diff_stvar_plt <- diff_var_plt_df %>%
  filter(bench_type == "stvar", .preserve = TRUE) %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v5.0q", "v4.2.1", "v0.6")
    )
  ) %>%
  ggplot() +
  geom_bar(
    aes(x = var_type, y = count, fill = bench_version),
    color = "grey20",
    position = "dodge",
    stat = "identity",
    show.legend = TRUE
  ) +
  facet_wrap(. ~ strat_ids, nrow = 1) +
  scale_y_continuous(label = scales::label_comma()) +
  scale_fill_manual(
    name = "Benchmark Version",
    values = bench_version_cols,
    breaks = c("v5.0q", "v4.2.1", "v0.6"),
    labels = c("v5.0q", "v4.2.1", "v0.6"),
    drop = FALSE
  ) +
  labs(x = "Variant Type", y = "Variant Count") +
  theme_minimal() +
  theme(legend.position = "bottom"))
```

```{r}
(diff_var_plt <- diff_smvar_plt +
  diff_stvar_plt +
  plot_layout(guides = , nrow = 2, ncol = 1) +
  plot_annotation(tag_levels = "A") %>%
    theme(
      legend.position = "bottom"
    ))
```

```{r}
ggsave(
    filename = here("manuscript", "figs", "diff_variant_counts.png"),
    plot = diff_var_plt,
    width = 8,
    height = 6,
    dpi = 300,
)
```


```{r}
diff_var_fld_chg <- diff_var_plt_df %>%
  mutate(
    var_size_bin = case_when(
      abs(var_size) < 15 ~ "<15bp",
      abs(var_size) < 50 ~ "15-49bp",
      abs(var_size) < 1001 ~ "50 - 1,000bp",
      abs(var_size) < 10001 ~ "1,001 - 10,000bp",
      TRUE ~ ">10kb"
    )
  ) %>%
  count(bench_version, ref, bench_type, var_type, var_size_bin, strat_ids) %>%
  pivot_wider(
    names_from = bench_version,
    values_from = n,
    id_cols = c(ref, bench_type, var_type, var_size_bin, strat_ids)
  ) %>%
  filter(
    !is.na(v0.6) | !is.na(v4.2.1),
    !(ref == "GRCh37" & bench_type == "smvar")
  ) %>%
  mutate(
    fold_chg = case_when(
      !is.na(v0.6) ~ v5.0q / v0.6,
      !is.na(v4.2.1) ~ v5.0q / v4.2.1,
      TRUE ~ NA
    )
  )
```


```{r}
diff_var_fld_chg %>%
  filter(strat_ids %in% c("HP", "MAP", "SD", "TR")) %>%
  mutate(
    bench_type = factor(
      bench_type,
      levels = c("smvar", "stvar"),
      labels = c("Small Variants", "Structural Variants")
    )
  ) %>%
  ggplot() +
  geom_point(
    aes(
      x = strat_ids,
      y = fold_chg,
      fill = var_size_bin,
      shape = var_type
    ),
    size = 4,
    color = "black",
    position = "jitterdodge"
  ) +
  facet_grid(bench_type ~ strat_ids, scales = "free") +
  scale_shape_manual(
    values = c(21, 22, 23, 24),
    guide = guide_legend(override.aes = list(fill = "grey80"))
  ) +
  scale_fill_viridis_d(
    labels = c("<15bp", "15-49bp", "50bp-1kb", "1kb-10kb", ">10kb"),
    guide = guide_legend(override.aes = list(shape = 21))
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  labs(
    x = "Difficult Genomic Context",
    y = "Fold Change Variant Count",
    fill = "Variants Type",
    shape = "Benchmark Set"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical"
  )
```

## Benchmark region characterization

- Number of bases in benchmark regions in v5 compared to v4 and v0.6

```{r}
bench_region_list <- list.files(
    path = here("resources/benchmarksets"),
    pattern = "_benchmark.bed",
    full.names = TRUE
) %>%
    set_names(str_extract(., "(?<=benchmarksets/).*(?=_benchmark.bed)"))

pg_region_list <- list(
    "PP_GRCh38_smvar" = here(
        "data/platinum-pedigree-data/NA12878_hq_v1.2.smallvar.bed.gz"
    ),
    "PP_GRCh38_stvar" = here(
        "data/platinum-pedigree-data/NA12878_hq_v1.2.svs.bed.gz"
    )
)
```


```{r}
regions_df <- c(
    bench_region_list,
    pg_region_list
) %>%
    map_dfr(
        read_tsv,
        col_names = c("chrom", "start", "end"),
        col_types = "cii",
        .id = "benchmarkset"
    ) %>%
    mutate(
        interval_size = end - start,
        chrom = if_else(str_detect(chrom, "chr"), chrom, str_c("chr", chrom))
    ) %>%
    separate(
        benchmarkset,
        into = c("bench_version", "ref", "var_type"),
        sep = "_"
    )

# Validate regions_df structure and no FIXME values
assert_that(
    is_tibble(regions_df),
    has_name(
        regions_df,
        c(
            "chrom",
            "start",
            "end",
            "interval_size",
            "bench_version",
            "var_type",
            "ref"
        )
    ),
    nrow(regions_df) > 0,
    all(regions_df$interval_size > 0)
)
```

### Total Included Base Comparisons

```{r}
## Get hg002q100v1.1 size
hg002fai_url <- "https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/HG002/assemblies/hg002v1.1.mat_Y_EBV_MT.fasta.gz.fai"
hg002fai_md5 <- "c84f852b1cd4a00b12e6439ae7a2dd87"

hg002fai <- tempfile()
download.file(url = hg002fai_url, destfile = hg002fai, quiet = TRUE)
if (identical(tools::md5sum(hg002fai), hg002fai_md5)) {
    stop("Downloaded hg002q100v1.1 fai file has incorrect md5sum")
}

hg002fai_df <- read_tsv(
    hg002fai,
    col_names = c("chrom", "length", "offset", "line_bases", "line_width"),
    col_types = "cicii"
) |>
    mutate(chrom = str_remove(chrom, "_.ATERNAL")) |>
    filter(chrom %in% paste0("chr", c(1:22, "X", "Y"))) |>
    select(chrom, length)
file.remove(hg002fai)

(hg002q100v1.1_size <- sum(hg002fai_df$length))
```

```{r}
ref_size_df <- list.files(
    here("results/ref_genome_sizes"),
    pattern = "_size.tsv",
    full.names = TRUE
) %>%
    set_names(str_extract(., "(?<=ref_genome_sizes/).*(?=_size.tsv)")) %>%
    map_dfr(
        read_tsv,
        col_types = "ciii",
        .id = "ref"
    ) %>%
    rename(chrom = '#id') |>
    mutate(
        chrom = if_else(str_detect(chrom, "chr"), chrom, str_c("chr", chrom)),
        asm_bp = length - N
    ) |>
    select(ref, chrom, asm_bp)
```

```{r}
total_ref_asm_bp <- ref_size_df |>
    group_by(ref) |>
    summarise(total_asm_bp = sum(asm_bp))
```

```{r}
regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
        chrom %in% paste0("chr", c(1:22, "X", "Y"))
    ) %>%
    group_by(var_type, ref, bench_version) %>%
    summarise(total_bp = sum(interval_size), .groups = "drop") %>%
    left_join(total_ref_asm_bp) %>%
    mutate(
        pct_ref_cvg = round(100 * (total_bp / total_asm_bp), 0),
        pct_q100_cvg = if_else(bench_version != "PP", round(100 * (total_bp / hg002q100v1.1_size), 0), NA),
        total_bp = format(total_bp, big.mark = ",")
    ) %>%
    arrange(var_type, bench_version, ref) %>%
    gt::gt()
```

Relative changes between v5q and v4.2.1/v0.6 by chromosome
```{r fig.width = 8, fig.height = 4}
(coverage_change_plt <- regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref == "GRCh37"),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    select(-starts_with("X")) %>%
    group_by(var_type, chrom, bench_version) %>%
    summarise(total_size = sum(interval_size), .groups = "drop") %>%
    mutate(
        vers = if_else(bench_version == "v5.0q", "new", "old"),
        chrom = factor(chrom, levels = paste0("chr", 1:22))
    ) %>%
    select(-bench_version) %>%
    pivot_wider(names_from = vers, values_from = total_size) %>%
    mutate(
        pct_change = 100 * (new - old) / old,
        total_change = new - old
    ) %>%
    ggplot() +
    geom_hline(yintercept = 0, color = "grey50") +
    geom_point(
        aes(
            x = chrom,
            y = pct_change,
            fill = total_change / 1000000,
            shape = var_type
        ),
        size = 4,
        color = "black",
        position = "jitterdodge"
    ) +
    scale_y_continuous(
        labels = scales::percent_format(scale = 1),
        n.breaks = 10
    ) +
    scale_fill_gradient2(
        low = "red",
        mid = "white",
        high = "blue",
        midpoint = 0,
        labels = scales::comma
    ) +
    scale_shape_manual(values = c(21, 24)) +
    labs(
        x = "Chromosome",
        y = "Coverage Change",
        fill = "Coverage change (Mb)",
        shape = "Variant Type"
    ) +
    theme_minimal() +
    theme(
        axis.text.x = element_text(angle = -45, hjust = 0),
        legend.position = "bottom"
    ))
```

```{r}
(ggsave(
    filename = here("manuscript", "figs", "benchmark_region_size_change.png"),
    plot = coverage_change_plt,
    width = 8,
    height = 4,
    dpi = 300
))
```

### Inclusion of Difficult Regions

```{r}
diff_coverage <- list.files(
    here("results/diff_region_coverage"),
    pattern = "_cov.bed",
    recursive = TRUE,
    full.names = TRUE
) %>%
    {
        set_names(
            .,
            str_extract(., "(?<=coverage/).*(?=_cov.bed)") %>%
                str_replace("/", "_")
        )
    } %>%
    map_dfr(
        read_tsv,
        col_names = c(
            "CHROM",
            "START",
            "END",
            "n_overlap",
            "bases_cov",
            "ivl_len",
            "frac_cov"
        ),
        col_types = "ciiiiid",
        .id = "strat"
    ) %>%
    filter(n_overlap > 0) %>%
    separate(
        strat,
        into = c("bench_version", "ref", "var_type", "strat"),
        sep = "_"
    )
```


```{r}
diff_cov_total <- diff_coverage %>%
    group_by(bench_version, ref, var_type, strat) %>%
    summarise(total_cov = sum(bases_cov))

diff_cov_total %>%
    ggplot() +
    geom_bar(
        aes(x = strat, y = total_cov, fill = bench_version),
        stat = "identity",
        position = "dodge"
    ) +
    facet_wrap(~var_type, ncol = 1) +
    theme_minimal()
```

#### Difficult Region Bases Included
Not sure how this is different from above - might just have been a renamed section and revised figures
```{r eval = FALSE}
(diff_included_tbl <- list.files(path = here("results/diff_region_coverage"), pattern = "_cov.bed$",recursive = TRUE, full.names = TRUE) %>% {tibble(file_path = .)} %>% 
   mutate(bench_id = str_extract(file_path, "(?<=diff_region_coverage/).*(?=/)"),
          diff_region = str_extract(file_path, "(?<=var/).*(?=_cov.bed)"))) %>% 
  
)
```


```{r eval = FALSE}

diff_included_plt_df <- diff_included_tbl %>%
    filter(
        (bench_version %in%
            c("v5q", "v421") &
            bench_type == "smvar" &
            ref_id == "grch38") |
            (bench_version %in%
                c("v5q", "v06") &
                bench_type == "stvar" &
                ref_id == "grch37"),
        chrom_scope == "autosomes"
    )
```

```{r eval=FALSE}
ggplot(diff_included_plt_df) +
    geom_point(
        aes(
            x = bench_type,
            y = overlap_bp,
            fill = context,
            shape = bench_version
        ),
        position = "jitterdodge"
    ) +
    scale_y_log10() +
    annotation_logticks(sides = "lr") +
    scale_shape_manual(values = c(21, 24, 22)) +
    labs(
        x = "Benchmark Type",
        y = "Included Bases (bp)",
        fill = "Genomic Context",
        shape = "Benchmark Version"
    ) +
    facet_wrap(~context, nrow = 1) +
    theme_minimal() +
    theme(legend.position = "bottom", legend.box = "vertical") +
    guides(
        fill = guide_legend(
            nrow = 2,
            byrow = TRUE,
            override.aes = list(shape = 21)
        )
    )
```

```{r eval=FALSE}
ggplot(
    diff_included_plt_df,
    aes(
        x = bench_type,
        y = included_pct
    )
) +
    geom_point(
        aes(
            fill = context,
            shape = bench_version
        ),
        position = position_jitterdodge(dodge.width = 0.5)
    ) +
    scale_shape_manual(values = c(21, 24, 22)) +
    scale_color_manual(values = c("grey20", "darkred")) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    labs(
        x = "Benchmark Type",
        y = "Included Bases (%)",
        fill = "Genomic Context",
        shape = "Benchmark Version"
    ) +
    facet_wrap(~context, nrow = 1) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        legend.box = "vertical"
    ) +
    guides(
        fill = guide_legend(
            nrow = 2,
            byrow = TRUE,
            override.aes = list(shape = 21)
        )
    )
```

```{r eval = FALSE}
diff_included_plt_df %>%
    select(
        ref,
        bench_type,
        context,
        bench_version,
        chrom_scope,
        included_pct
    ) %>%
    filter(chrom_scope == "autosomes") %>%
    # group_by(bench_type) %>%
    # pivot_wider(names_from = bench_version, values_from = included_pct) #%>%
    # mutate(pct_change = (v5q - v421)/v421) %>%
    arrange(bench_type, context, chrom_scope) %>%
    gt::gt()
```


```{r}
diff_var_fld_chg <- diff_var_plt_df %>%
  mutate(
    var_size_bin = case_when(
      abs(var_size) < 15 ~ "<15bp",
      abs(var_size) < 50 ~ "15-49bp",
      abs(var_size) < 1001 ~ "50 - 1,000bp",
      abs(var_size) < 10001 ~ "1,001 - 10,000bp",
      TRUE ~ ">10kb"
    )
  ) %>%
  count(bench_version, ref, bench_type, var_type, var_size_bin, strat_ids) %>%
  pivot_wider(
    names_from = bench_version,
    values_from = n,
    id_cols = c(ref, bench_type, var_type, var_size_bin, strat_ids)
  ) %>%
  filter(
    !is.na(v0.6) | !is.na(v4.2.1),
    !(ref == "GRCh37" & bench_type == "smvar")
  ) %>%
  mutate(
    fold_chg = case_when(
      !is.na(v0.6) ~ v5.0q / v0.6,
      !is.na(v4.2.1) ~ v5.0q / v4.2.1,
      TRUE ~ NA
    )
  )
```


```{r}
diff_var_fld_chg %>%
  filter(strat_ids %in% c("HP", "MAP", "SD", "TR")) %>%
  mutate(
    bench_type = factor(
      bench_type,
      levels = c("smvar", "stvar"),
      labels = c("Small Variants", "Structural Variants")
    )
  ) %>%
  ggplot() +
  geom_point(
    aes(
      x = strat_ids,
      y = fold_chg,
      fill = var_size_bin,
      shape = var_type
    ),
    size = 4,
    color = "black",
    position = "jitterdodge"
  ) +
  facet_grid(bench_type ~ strat_ids, scales = "free") +
  scale_shape_manual(
    values = c(21, 22, 23, 24),
    guide = guide_legend(override.aes = list(fill = "grey80"))
  ) +
  scale_fill_viridis_d(
    labels = c("<15bp", "15-49bp", "50bp-1kb", "1kb-10kb", ">10kb"),
    guide = guide_legend(override.aes = list(shape = 21))
  ) +
  scale_y_continuous(
    labels = scales::comma
  ) +
  labs(
    x = "Difficult Genomic Context",
    y = "Fold Change Variant Count",
    fill = "Variants Type",
    shape = "Benchmark Set"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.box = "vertical"
  )
```

### Benchmark Interval Size Distributions

Platinum pedigree truthsets downloaded from aws using `aws s3 sync --no-sign-request s3://platinum-pedigree-data/truthset_v1.2/ . 
```{r}
(interval_size_dist_plt <- regions_df %>%
  filter(
    bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
    (var_type == "smvar" & ref == "GRCh38") |
      (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
    chrom %in% paste0("chr", c(1:22))
  ) %>%
  select(-starts_with("X")) %>%
  mutate(
    bench_version = factor(
      bench_version,
      levels = c("v4.2.1", "v0.6", "v5.0q", "PP")
    ),
    var_type = case_when(
      var_type == "smvar" ~ "Small Variants",
      var_type == "stvar" ~ "Structural Variants"
    )
  ) %>%
  ggplot() +
  geom_density(
    aes(x = interval_size, fill = bench_version),
    position = "identity",
    kernel = "gaussian",
    alpha = 0.5,
    bw = "sj",
    adjust = 0.20,
    outline.type = "upper",
    trim = TRUE
  ) +
  scale_x_log10(labels = scales::comma) +
  annotation_logticks(sides = "b") +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(~var_type, ncol = 1, scales = "free_y") +
  theme_minimal() +
  theme(legend.position = "bottom") +
  labs(
    x = "Benchmark Interval Size (bp)",
    y = "Included Based",
    fill = "Benchmark Version"
  ))
```

```{r}
(interval_count_plt <- regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    ggplot() +
    geom_bar(
        aes(x = bench_version, fill = bench_version),
        color = "grey20",
        position = "dodge",
        alpha = 0.5
    ) +
    facet_wrap(~var_type, ncol = 2, scales = "free") +
    labs(
        x = "Benchmark Version",
        y = "Number of Intervals",
        fill = "Benchmark Version"
    ) +
    scale_y_continuous(labels = scales::comma) +
    theme_minimal() +
    theme(legend.position = "none"))
```

```{r}
(interval_plt <- interval_count_plt + 
    interval_size_dist_plt +
    plot_layout(ncol = 1))
```

```{r}
ggsave(
    here("manuscript/figs/benchmark_intervals.png"),
    interval_plt,
    width = 8,
    height = 6
)
```

Number of regions by benchmark set.
```{r}
regions_df %>%
    filter(
        bench_version %in% c("v5.0q", "v4.2.1", "v0.6", "PP"),
        (var_type == "smvar" & ref == "GRCh38") |
            (var_type == "stvar" & ref %in% c("GRCh37", "GRCh38")),
        chrom %in% paste0("chr", c(1:22))
    ) %>%
    group_by(bench_version, var_type, ref) %>%
    count() %>%
    mutate(
        bench_version = factor(
            bench_version,
            levels = c("v4.2.1", "v0.6", "v5.0q", "PP")
        )
    ) %>%
    arrange(var_type, bench_version) %>%
    ungroup() %>%
    select(var_type, ref, bench_version, n) %>%
    gt::gt() %>%
    gt::tab_header(title = "Number of intervals in Benchmark Regions") %>%
    gt::fmt_integer(columns = n) %>%
    gt::cols_align(
        columns = c("var_type", "ref", "bench_version"),
        align = "right"
    ) %>%
    gt::cols_label(
        var_type = "Variant Type",
        ref = "Reference",
        bench_version = "Benchmark",
        n = "Number of Intervals"
    )
```


## Exclusions

- __TODO__ Bases removed due to each exclusion (upset plot?)
- __TODO__ Variants removed due to each exclusion (upset plot?)
- __TODO__ Variants and bases not in v5 but in previous versions

```{r}
exclusion_intersect_files <- list.files(
    path = here("data/20250117_v0.020_HG002Q100v1.1/draft_benchmarksets"),
    pattern = "exclusion_intersection_summary.csv",
    recursive = TRUE,
    full.names = TRUE
) %>%
    set_names(str_remove(., ".*-excluded/"))

exclusion_intersect_df <- exclusion_intersect_files %>%
    map_dfr(read_csv, show_col_types = FALSE, .id = "benchmarkset") %>%
    separate(
        col = benchmarkset,
        into = c("ref", "assembly", "bench_type", "varcall"),
        extra = "drop",
        sep = "_"
    ) %>%
    select(-assembly, -varcall) %>%
    rename(
        dip_overlap_bp = bp,
        dip_excluded_pct = pct_of_initial
    ) %>%
    mutate(
        start_end = case_when(
            str_detect(genomic_region, "start") ~ "start",
            str_detect(genomic_region, "end") ~ "end",
            TRUE ~ ""
        ),
        genomic_region = str_remove(genomic_region, "_(slop|sorted).*bed$"),
        exclusion = case_when(
            genomic_region == "HG002Q100-errors" ~ genomic_region,
            genomic_region == "initial" ~ "diploid-regions",
            str_detect(genomic_region, "HG002Q100-") ~ str_extract(
                genomic_region,
                "(?<=HG002Q100-).*"
            ),
            str_detect(genomic_region, "_dipcall-z2k_") ~ str_extract(
                genomic_region,
                "(?<=_dipcall-z2k_).*"
            ),
            TRUE ~ genomic_region
        )
    )
```

```{r}
exclusion_gt_tbl <- exclusion_intersect_df %>%
    mutate(exclusion = trimws(paste(exclusion, start_end), "both")) %>%
    select(ref, exclusion, bench_type, dip_overlap_bp, dip_excluded_pct) %>%
    filter(!(exclusion %in% c("benchmark_regions", "diploid-regions"))) %>%
    pivot_wider(
        names_from = ref,
        values_from = c(dip_overlap_bp, dip_excluded_pct)
    ) %>%
    arrange(-dip_overlap_bp_CHM13v2.0)

make_exclusion_tbl <- function(exclusion_tbl, table_title) {
    gt::gt(exclusion_tbl) %>%
        gt::fmt_integer(
            columns = c(
                dip_overlap_bp_GRCh37,
                dip_overlap_bp_GRCh38,
                dip_overlap_bp_CHM13v2.0
            )
        ) %>%
        gt::fmt_number(
            columns = c(
                dip_excluded_pct_GRCh37,
                dip_excluded_pct_GRCh38,
                dip_excluded_pct_CHM13v2.0
            ),
            decimals = 2
        ) %>%
        gt::tab_spanner(
            label = "GRCh37",
            columns = c(dip_overlap_bp_GRCh37, dip_excluded_pct_GRCh37)
        ) %>%
        gt::tab_spanner(
            label = "GRCh38",
            columns = c(dip_overlap_bp_GRCh38, dip_excluded_pct_GRCh38)
        ) %>%
        gt::tab_spanner(
            label = "CHM13v2.0",
            columns = c(dip_overlap_bp_CHM13v2.0, dip_excluded_pct_CHM13v2.0)
        ) %>%
        gt::cols_label(
            dip_overlap_bp_GRCh37 = "bp",
            dip_excluded_pct_GRCh37 = "%",
            dip_overlap_bp_GRCh38 = "bp",
            dip_excluded_pct_GRCh38 = "%",
            dip_overlap_bp_CHM13v2.0 = "bp",
            dip_excluded_pct_CHM13v2.0 = "%"
        ) %>%
        gt::tab_header(
            title = table_title
        ) %>%
        gt::cols_align(columns = c(exclusion, bench_type), align = "right")
}
```

```{r}
combined_exclusion_tbl <- exclusion_intersect_df %>%
    mutate(exclusion = trimws(paste(exclusion, start_end), "both")) %>%
    select(ref, exclusion, bench_type, dip_overlap_bp, dip_excluded_pct) %>%
    filter(!(exclusion %in% c("benchmark_regions", "diploid-regions"))) %>%
    pivot_wider(
        names_from = ref,
        values_from = c(dip_overlap_bp, dip_excluded_pct)
    ) %>%
    arrange(-dip_overlap_bp_CHM13v2.0) %>%
    mutate(
        bench_type = case_when(
            exclusion == "total_excluded" ~ bench_type,
            exclusion == "svs-and-simple-repeats" ~ bench_type,
            exclusion == "self-discrep" ~ bench_type,
            TRUE ~ "both"
        )
    ) %>%
    distinct()
```


```{r}
combined_exclusion_tbl %>%
    make_exclusion_tbl(table_title = "Benchmark Set Exclusions")
```



```{r}
list.files(
  path = here("results/exclusions"),
  pattern = "exclusions_intersection_table.csv",
  recursive = TRUE,
  full.names = TRUE
) %>%
  {
    set_names(., str_extract(., "(?<=exclusions/).*(?=/)"))
  } %>%
  map_dfr(read_csv, show_col_types = FALSE, .id = "benchmarkset") %>%
  separate(
    col = benchmarkset,
    into = c("bench_version", "ref", "bench_type"),
    sep = "_"
  ) %>% 
    View(.)
```
