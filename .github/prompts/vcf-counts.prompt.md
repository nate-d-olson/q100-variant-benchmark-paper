---
agent: Plan
description: "Change the pipeline from using multiple methods for variant counting to bcftools query based counts."
model: Claude Opus 4.5 (Preview) (copilot)
tools: ['vscode', 'execute', 'read', 'edit', 'search', 'web', 'context7/*', 'deepwiki/*', 'firecrawl/*', 'serena/*', 'ms-python.python/getPythonEnvironmentInfo', 'ms-python.python/getPythonExecutableCommand', 'ms-python.python/installPythonPackage', 'ms-python.python/configurePythonEnvironment', 'todo']
---

Modify the Snakemake pipeline to use bcftools query to generate tsv tables for each benchmark set for use in getting variant counts instead of the current combination of methods.

Create a plan to implement this change including changes to snakemake files, updating the config.yaml file to allow for descriptions for difficult region bed files to be used in VCF header lines, and revising the README to reflect the new output structure. Helper scripts created for implementation should go in the `scratch/` directory and scripts use in the pipeline should go in the `workflow/scripts/` directory. No changes should be made to the quarto files in the `analysis/` directory as part of this task. Write the plan in detailed steps as a prompt file in `.github/prompts/varcount-claude.propmpt.md`. Do not make any code changes yet.

Current variant counts used in manuscript analysis:

- chromosome levels benchmark variant counts: rtg-tools vcfstats
- SV length distribution counts: custom script parsing bcftools query output
- context counts: custom script parsing bcftools query output

Instead of three different methods and output files bcftools query will be used to generate individual tsv files for each benchmark set.

Multiallelic variants will be split using `bcftools norm -m -any` before counting so that each alt allele is counted separately.

The benchmark VCFs fill be annotated with the difficult regions bed files using `bcftools annotate --annotations` with the `-a` option for each stratification bed file. So that difficult region variant counts can be obtained directly from the tsv files in the analysis quarto files. Similarly, the benchmark VCFs will be annotated with the benchmark regions bed files to get counts within benchmark regions. The v5q benchmark variant VCF files will also be annotated with the exclusion bed files for use in counting variants excluded from the benchmark vcf for each exclusion. Use the `--min-overlap 0.20` option to require at least 20% of the variant to overlap regions in the difficult regions bed files. For the benchmark regions bed files and exclusion bed files use the default overlap of any overlap.

The tsv files generated by bcftools query will be stored in `results/var_tables/{benchmark_set}/` with filenames indicating the benchmark set. Annotated VCFs will be stored in `results/annotated_vcfs/{benchmark_set}/` with filenames indicating the benchmark set and the stratification or exclusion used for annotation. Use the `--header-lines` to add header lines to the annotated VCF files based on the bed file name and description. 

The header lines will look like this for this difficult region bed files:
`##INFO=<ID=STRAT_<STRAT_NAME>,Number=0,Type=Flag,Description="Variant overlaps <STRAT_DESCRIPTION>">`

For the v5 exclusions that header lines will look like this:
`##INFO=<ID=EXCL_<EXCL_NAME>,Number=0,Type=Flag,Description="Variant overlaps exclusion: <EXCL_DESCRIPTION>">`.

For the benchmark regions bed files the header lines will look like this:
`##INFO=<ID=BMKREGIONS,Number=0,Type=Flag,Description="Variant is within benchmark regions">`.

Modify the config.yaml file to allow for adding descriptions for each difficult region bed file to be used in the VCF header lines. The 

The TSV files generated by bcftools query will have the following columns:

- CHROM: chromosome
- POS: variant position
- END: variant end position
- GT: variant genotype
- VKX: unique variant key
- N_ALT (This is a sanity check and should be 1 for all rows after splitting multiallelics)
- TYPE: variant type
- STRLEN REF: with reference allele length
- STRLEN ALT: alternate allele length
- ILEN: indel length (for insertions and deletions)
- annotations (this will be multiple columns): binary columns for each difficult region, benchmark region, and exclusion used for annotation (1 if variant overlaps the region, 0 if not)
- INFO fields: separate columns for any additional INFO fields to be included from the VCF (e.g., SVTYPE, SVLEN, etc.), these will be different for each benchmark set.

Use the bcftools documentation for reference https://samtools.github.io/bcftools/bcftools.html. 

Use the snakemake documentation for reference https://snakemake.readthedocs.io/en/stable/. The helper function https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#helpers-for-defining-rules. The functions snakemake api documentation https://snakemake.readthedocs.io/en/stable/api_reference/snakemake.html might be helpful as well.

