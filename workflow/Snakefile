"""
Pipeline to generate and download input files for v5q variant benchmark set manuscript
"""

from snakemake.utils import min_version, validate

min_version("8.0")


configfile: "config/config.yaml"


validate(config, schema="../config/schema/config.schema.yaml")

wrapper_prefix = "v3.3.3"

REF = list(config.get("references", {}).keys())
BENCHMARK = list(config.get("benchmarksets", {}).keys())
STRAT = list(config["references"]["GRCh38"].get("stratifications", {}).keys())


# Rules that don't require cluster resources
localrules:
    all,
    index_vcf,


onstart:
    print("=" * 60)
    print("Q100 Variant Benchmark Pipeline")
    print("=" * 60)
    print(f"Configuration: config/config.yaml")
    print(f"Benchmarks: {len(config['benchmarksets'])}")
    print(f"Workflow directory: {workflow.basedir}")
    print(f"Working directory: {os.getcwd()}")
    print("=" * 60)


onsuccess:
    print("=" * 60)
    print("Pipeline completed successfully!")
    print("=" * 60)


onerror:
    print("=" * 60)
    print("Pipeline failed. Check log files in logs/ directory.")
    print("=" * 60)


include: "rules/common.smk"
include: "rules/downloads.smk"
include: "rules/vcf_processing.smk"
include: "rules/ref_processing.smk"
include: "rules/var_tables.smk"
include: "rules/exclusions.smk"
include: "rules/benchmark_comparisons.smk"
include: "rules/stratify_bench.smk"
include: "rules/diff_tables.smk"


rule all:
    input:
        get_var_table_inputs,
        get_exclusion_table_inputs,
        expand(
            "results/ref_genome_sizes/{ref}_size.tsv",
            ref=["GRCh37", "GRCh38", "CHM13v2.0"],
        ),
        expand(
            "results/diff_region_coverage/{benchmark}/{strat}_cov.bed",
            benchmark=BENCHMARK,
            strat=STRAT,
        ),
        # expand(
        #     "results/stats/{comp_id}_variants.csv",
        #     comp_id=config.get("comparisons", {}).keys(),
        # ),
        # expand(
        #     "results/stats/{comp_id}_regions.csv",
        #     comp_id=config.get("comparisons", {}).keys(),
        # ),
        # expand(
        #     "results/stratified_bench/{comp_id}/summary_by_variant.tsv",
        #     comp_id=[
        #         c
        #         for c, conf in config.get("comparisons", {}).items()
        #         if conf.get("type") == "stvar"
        #     ],
        # ),
        "results/stratified_bench/v5_vs_v0.6_stvar/TR_regions_within.tsv",
        "results/stratified_bench/v5_vs_v0.6_stvar/TR_regions_complement.tsv",
        "results/stratified_bench/v5_vs_v0.6_stvar/TR_inverse_within.tsv",
        "results/stratified_bench/v5_vs_v0.6_stvar/TR_inverse_complement.tsv",
        # expand(
        #     "results/stratified_bench/{comp_id}/summary_by_region.tsv",
        #     comp_id=[
        #         c
        #         for c, conf in config.get("comparisons", {}).items()
        #         if conf.get("type") == "stvar"
        #     ],
        # ),
