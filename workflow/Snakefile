"""
Pipeline to generate and download input files for v5q variant benchmark set manuscript
"""

from snakemake.utils import min_version, validate

min_version("8.0")


configfile: "config/config.yaml"


validate(config, schema="../config/schema/config.schema.yaml")

wrapper_prefix = "v3.3.3"

REF = list(config.get("references", {}).keys())
BENCHMARK = list(config.get("benchmarksets", {}).keys())
STRAT = list(config["references"]["GRCh38"].get("stratifications", {}).keys())


# Rules that don't require cluster resources
localrules:
    all,
    index_vcf,


onstart:
    print("=" * 60)
    print("Q100 Variant Benchmark Pipeline")
    print("=" * 60)
    print(f"Configuration: config/config.yaml")
    print(f"Benchmarks: {len(config['benchmarksets'])}")
    print(f"Workflow directory: {workflow.basedir}")
    print(f"Working directory: {os.getcwd()}")
    print("=" * 60)


onsuccess:
    print("=" * 60)
    print("Pipeline completed successfully!")
    print("=" * 60)


onerror:
    print("=" * 60)
    print("Pipeline failed. Check log files in logs/ directory.")
    print("=" * 60)


include: "rules/common.smk"
include: "rules/benchmark_comparisons.smk"
include: "rules/downloads.smk"
include: "rules/genomic_context_tables.smk"
include: "rules/exclusions.smk"
include: "rules/ref_processing.smk"
include: "rules/genomic_context_metrics.smk"
include: "rules/stratify_bench.smk"
include: "rules/vcf_processing.smk"
# Optional rule-all outputs (currently disabled):
# - results/stats/{comp_id}_variants.csv
# - results/stats/{comp_id}_regions.csv
# - results/stratified_bench/{comp_id}/summary_by_variant.tsv (type=stvar)
# - results/stratified_bench/{comp_id}/summary_by_region.tsv (type=stvar)
# - results/stratified_bench/v5_vs_v0.6_stvar/TR_regions_within.tsv
# - results/stratified_bench/v5_vs_v0.6_stvar/TR_regions_complement.tsv
# - results/stratified_bench/v5_vs_v0.6_stvar/TR_inverse_within.tsv
# - results/stratified_bench/v5_vs_v0.6_stvar/TR_inverse_complement.tsv
include: "rules/var_counts.smk"
include: "rules/var_tables.smk"


rule all:
    input:
        get_var_table_inputs,
        expand(
            "results/ref_genome_sizes/{ref}_size.tsv",
            ref=["GRCh37", "GRCh38", "CHM13v2.0"],
        ),
        expand(
            "results/genomic_context/{benchmark}/genomic_context_coverage_table.csv",
            benchmark=BENCHMARK,
        ),
        expand(
            "results/genomic_context/{benchmark}/variants_by_genomic_context.parquet",
            benchmark=BENCHMARK,
        ),
        ## Benchmarkset variant counts by type and difficult region stratifications
        expand(
            "results/genomic_context/{benchmark}/variants_by_genomic_context.parquet",
            benchmark=BENCHMARK,
        ),
        ## Per-exclusion impact: BED metrics + variant counts
        get_exclusion_impact_targets,
        ## Exclusion interactions (upset-style decomposition)
        get_exclusion_interaction_targets,
        ## Cross-version comparison: old benchmark vs v5.0q exclusion status
        expand(
            "results/exclusions/{comp_id}/old_only_summary.csv",
            comp_id=config.get("comparisons", {}).keys(),
        ),
