"""
Pipeline to generate and download input files for v5q variant benchmark set manuscript
"""

from snakemake.utils import min_version, validate

min_version("8.0")


configfile: "config/config.yaml"


validate(config, schema="../config/schema/config.schema.yaml")

wrapper_prefix = "v3.3.3"

REF = list(config.get("references", {}).keys())
BENCHMARK = list(config.get("benchmarksets", {}).keys())


# Rules that don't require cluster resources
localrules:
    all,
    index_vcf,


onstart:
    print("=" * 60)
    print("Q100 Variant Benchmark Pipeline")
    print("=" * 60)
    print(f"Configuration: config/config.yaml")
    print(f"Benchmarks: {len(config['benchmarksets'])}")
    print(f"Workflow directory: {workflow.basedir}")
    print(f"Working directory: {os.getcwd()}")
    print("=" * 60)


onsuccess:
    print("=" * 60)
    print("Pipeline completed successfully!")
    print("=" * 60)


onerror:
    print("=" * 60)
    print("Pipeline failed. Check log files in logs/ directory.")
    print("=" * 60)


include: "rules/common.smk"
include: "rules/downloads.smk"
include: "rules/ref_processing.smk"
include: "rules/vcf_processing.smk"
include: "rules/annotation.smk"
include: "rules/genomic_context_analysis.smk"
include: "rules/exclusions.smk"
include: "rules/benchmark_comparisons.smk"
include: "rules/chr8_synteny.smk"


rule all:
    input:
        expand(
            "results/variant_tables/{benchmark}/variants.parquet",
            benchmark=BENCHMARK,
        ),
        expand(
            "results/ref_genome_sizes/{ref}_size.tsv",
            ref= ["GRCh37", "GRCh38", "CHM13v2.0"],
        ),
        expand(
            "results/genomic_context/{benchmark}/genomic_context_coverage_table.csv",
            benchmark=BENCHMARK,
        ),
        expand(
            "results/genomic_context/{benchmark}/variants_by_genomic_context.parquet",
            benchmark=BENCHMARK,
        ),
        ## Per-exclusion impact: BED metrics + variant counts
        get_exclusion_impact_targets,
        ## Exclusion interactions (upset-style decomposition)
        get_exclusion_interaction_targets,
        ## Cross-version comparison: old benchmark vs v5.0q exclusion status
        expand(
            "results/exclusions/{comp_id}/old_only_summary.csv",
            comp_id=config.get("comparisons", {}).keys(),
        ),
        ## Chr8 synteny figure (optional, enabled when chr8_synteny is in config)
        get_chr8_synteny_targets,
